<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EscarolaOS v13.5 - Enterprise Architecture</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ==========================================================================
           SISTEMA DE DISEÑO ESCAROLA OS - DEFINICIÓN DE VARIABLES MAESTRAS
           ==========================================================================
        */
        :root {
            --verde-bosque: #1b3022;
            --verde-oscuro: #14241a;
            --terracota: #b0413e;
            --cantera: #d9d4c7;
            --dorado: #c5a059;
            --negro: #0a0a0a;
            --glass-white: rgba(255, 255, 255, 0.05);
            --glass-dark: rgba(0, 0, 0, 0.6);
            --border-light: rgba(217, 212, 199, 0.15);
            --shadow-3d: 0 40px 80px rgba(0,0,0,0.8);
            --radius-max: 60px;
            --radius-mid: 35px;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* NORMALIZACIÓN Y RESET DE INTERFAZ 
        */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body { 
            background: var(--verde-bosque); 
            color: var(--cantera); 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --------------------------------------------------------------------------
           CAPA DE SEGURIDAD: PINPAD AUTHENTICATION (NÚCLEO DE ACCESO)
           --------------------------------------------------------------------------
        */
        #login-screen { 
            position: fixed; 
            inset: 0; 
            background: radial-gradient(circle at center, #1b3022 0%, #050505 100%); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 999999;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .login-branding {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 1s ease-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-branding h1 { 
            font-size: clamp(2.5rem, 10vw, 4rem); 
            letter-spacing: 20px; 
            color: #fff; 
            font-weight: 900; 
            text-shadow: 0 15px 45px rgba(0,0,0,0.6);
            margin-left: 20px;
        }
        
        .login-branding h1 span { 
            color: var(--dorado); 
        }

        .login-branding p { 
            color: var(--dorado); 
            letter-spacing: 10px; 
            font-size: 0.8rem; 
            margin-top: 20px; 
            font-weight: 800; 
            opacity: 0.8;
            text-transform: uppercase;
        }

        /* DISPLAY DE PIN (INDICADORES VISUALES) */
        .pin-display { 
            display: flex; 
            gap: 30px; 
            margin-bottom: 70px; 
        }

        .pin-dot { 
            width: 24px; 
            height: 24px; 
            border: 3px solid var(--dorado); 
            border-radius: 50%; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .pin-dot.filled { 
            background: var(--dorado); 
            box-shadow: 0 0 30px var(--dorado), inset 0 0 5px white; 
            transform: scale(1.4); 
        }

        /* TECLADO NUMÉRICO PRO */
        .numpad-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 25px; 
            width: 100%; 
            max-width: 380px; 
        }

        .key-btn { 
            aspect-ratio: 1; 
            border-radius: 50%; 
            border: 2px solid var(--border-light); 
            background: var(--glass-white); 
            color: var(--dorado); 
            font-size: 2.4rem; 
            font-weight: 300; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: 0.15s;
            user-select: none;
            backdrop-filter: blur(10px);
        }

        .key-btn:active { 
            background: var(--dorado); 
            color: var(--verde-oscuro); 
            transform: scale(0.85); 
            box-shadow: 0 0 40px var(--dorado);
        }

        .key-btn.action-red { color: var(--terracota); }
        .key-btn.action-blue { color: #59a5c5; }

        /* --------------------------------------------------------------------------
           ESTRUCTURA PRINCIPAL DE LA APLICACIÓN (SHELL)
           --------------------------------------------------------------------------
        */
        .app-container {
            position: relative;
            height: 100vh;
            width: 100%;
            background: var(--verde-bosque);
        }

        .view-layer { 
            display: none; 
            height: 100vh; 
            width: 100%;
            overflow-y: auto; 
            padding: 35px; 
            padding-bottom: 240px; 
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .view-layer::-webkit-scrollbar { display: none; }

        /* TARJETAS MÓDULO (GLASSMORPHISM) */
        .glass-module { 
            background: var(--verde-oscuro); 
            border-radius: var(--radius-mid); 
            padding: 40px; 
            margin-bottom: 35px; 
            border: 1.5px solid var(--border-light); 
            box-shadow: var(--shadow-3d); 
            position: relative;
            overflow: hidden;
        }

        .glass-module::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, transparent, var(--dorado), transparent);
            opacity: 0.3;
        }

        .module-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 35px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .module-header h2 {
            font-size: 1.4rem;
            text-transform: uppercase;
            letter-spacing: 5px;
            color: var(--dorado);
            font-weight: 900;
        }

        /* --------------------------------------------------------------------------
           MÓDULO DE CAPITAL Y FINANZAS (TOTALIZADORES)
           --------------------------------------------------------------------------
        */
        .hero-balance {
            text-align: center;
            padding: 80px 20px;
            background: linear-gradient(180deg, #1b3022 0%, #000 100%);
            border-radius: var(--radius-max);
            border-bottom: 6px solid var(--dorado);
            margin-bottom: 45px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            animation: slideInUp 0.8s ease;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-balance span {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 8px;
            font-weight: 800;
            opacity: 0.6;
            color: var(--cantera);
        }

        .hero-balance h1 {
            font-size: clamp(3.5rem, 15vw, 6rem);
            font-weight: 900;
            letter-spacing: -5px;
            color: #fff;
            margin: 20px 0;
            text-shadow: 0 15px 40px rgba(0,0,0,0.9);
        }

        .financial-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 45px;
        }

        .kpi-card {
            background: var(--glass-white);
            padding: 35px 20px;
            border-radius: 40px;
            border: 1px solid var(--border-light);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .kpi-card:active { 
            transform: translateY(10px); 
            background: rgba(255,255,255,0.1); 
        }

        .kpi-card span { 
            font-size: 0.7rem; 
            font-weight: 900; 
            opacity: 0.5; 
            text-transform: uppercase; 
            letter-spacing: 3px; 
            display: block;
            margin-bottom: 12px;
        }

        .kpi-card h4 { 
            font-size: 2rem; 
            font-weight: 800; 
            color: #fff; 
        }

        /* --------------------------------------------------------------------------
           REGISTRO DE TRANSACCIONES (INPUTS OPTIMIZADOS)
           --------------------------------------------------------------------------
        */
        .field-group { margin-bottom: 30px; }

        .field-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 900;
            color: var(--dorado);
            text-transform: uppercase;
            margin: 0 0 15px 20px;
            letter-spacing: 3px;
        }

        .field-group input, 
        .field-group select, 
        .field-group textarea {
            width: 100%;
            padding: 26px;
            border-radius: 25px;
            background: #000;
            border: 2px solid var(--border-light);
            color: #fff;
            font-size: 1.2rem;
            outline: none;
            transition: 0.4s;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.4);
        }

        .field-group input:focus { 
            border-color: var(--dorado); 
            box-shadow: 0 0 25px rgba(197,160,89,0.15), inset 0 5px 15px rgba(0,0,0,0.5); 
        }

        /* BOTONES DE GRAN FORMATO */
        .dual-btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 40px;
        }

        .btn-core {
            height: 100px;
            border-radius: 35px;
            border: none;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-green { 
            background: var(--dorado); 
            color: var(--verde-oscuro); 
            box-shadow: 0 20px 45px rgba(197,160,89,0.3); 
        }

        .btn-red { 
            background: var(--terracota); 
            color: #fff; 
            box-shadow: 0 20px 45px rgba(176,65,62,0.3); 
        }

        .btn-core:active { 
            transform: scale(0.9); 
            filter: brightness(1.3); 
        }

        /* --------------------------------------------------------------------------
           RELOJ EN TIEMPO REAL (RESPONSIVO PARA IOS)
           --------------------------------------------------------------------------
        */
        .clock-billboard {
            text-align: center;
            padding: 90px 20px;
            background: radial-gradient(circle at center, #233d2c 0%, #000 100%);
            border-radius: var(--radius-max);
            border: 4px solid var(--dorado);
            margin-bottom: 50px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
        }

        #timer-display { 
            font-size: clamp(4rem, 20vw, 10rem); 
            font-weight: 900; 
            color: #fff; 
            line-height: 0.8; 
            text-shadow: 0 20px 50px rgba(0,0,0,1);
            font-variant-numeric: tabular-nums;
            position: relative;
            z-index: 2;
        }

        #date-display { 
            color: var(--dorado); 
            font-weight: 800; 
            letter-spacing: 8px; 
            text-transform: uppercase; 
            margin-top: 35px; 
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .punch-station { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 35px; 
        }

        .btn-punch {
            height: 250px;
            border-radius: 55px;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 25px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            transition: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        .btn-punch i { font-size: 4.5rem; }
        .btn-in { background: var(--dorado); color: var(--verde-oscuro); }
        .btn-out { background: var(--terracota); color: #fff; }

        .btn-punch:active { 
            transform: scale(0.85) rotate(-3deg); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        }

        /* --------------------------------------------------------------------------
           SISTEMA DE NÓMINA Y ADMIN (DISEÑO DE LISTAS)
           --------------------------------------------------------------------------
        */
        .payroll-item {
            background: var(--glass-white);
            border-radius: 35px;
            padding: 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 8px solid var(--dorado);
            animation: slideLeft 0.6s ease forwards;
        }

        @keyframes slideLeft {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .payroll-info h3 { 
            font-size: 1.4rem; 
            color: #fff; 
            margin-bottom: 8px; 
            letter-spacing: 1px;
        }

        .payroll-info p { 
            font-size: 0.9rem; 
            font-weight: 700; 
            opacity: 0.5; 
            text-transform: uppercase; 
            letter-spacing: 2px;
        }

        .payroll-data { text-align: right; }
        .payroll-data h2 { 
            font-size: 1.8rem; 
            color: var(--dorado); 
            font-weight: 900; 
        }

        .payroll-data small { 
            font-size: 0.75rem; 
            opacity: 0.4; 
            font-weight: 800; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --------------------------------------------------------------------------
           BARRA DE NAVEGACIÓN (APPLE STYLE TAB BAR)
           --------------------------------------------------------------------------
        */
        #tab-navigation { 
            position: fixed; 
            bottom: 45px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 92%; 
            max-width: 720px; 
            background: rgba(5, 5, 5, 0.98); 
            border-radius: 80px; 
            border: 2px solid var(--dorado); 
            display: none; 
            grid-template-columns: repeat(5, 1fr); 
            padding: 25px 15px; 
            z-index: 99999; 
            backdrop-filter: blur(40px); 
            box-shadow: 0 50px 120px rgba(0,0,0,1);
            padding-bottom: calc(25px + var(--safe-bottom));
        }

        .nav-item { 
            text-align: center; 
            color: var(--cantera); 
            opacity: 0.3; 
            cursor: pointer; 
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            position: relative;
        }

        .nav-item.active { 
            opacity: 1; 
            color: var(--dorado); 
            transform: translateY(-20px); 
        }

        .nav-item i { 
            font-size: 2.1rem; 
            display: block; 
            margin-bottom: 10px; 
            text-shadow: 0 0 20px rgba(197,160,89,0);
        }

        .nav-item.active i {
            text-shadow: 0 0 20px rgba(197,160,89,0.6);
        }

        .nav-item span { 
            font-size: 0.7rem; 
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
        }

        /* --------------------------------------------------------------------------
           MODALES Y NOTIFICACIONES (SISTEMA DE ALERTAS)
           --------------------------------------------------------------------------
        */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.99); 
            z-index: 1000000; 
            align-items: center; 
            justify-content: center; 
            padding: 30px; 
        }

        .modal-window { 
            width: 100%; 
            max-width: 620px; 
            background: var(--verde-oscuro); 
            border-radius: 60px; 
            padding: 60px; 
            border: 4px solid var(--dorado); 
            box-shadow: 0 0 150px rgba(0,0,0,1);
            position: relative;
        }

        .task-row {
            display: flex;
            align-items: center;
            gap: 25px;
            padding: 28px;
            background: rgba(255,255,255,0.04);
            border-radius: 30px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: 0.3s;
        }

        .task-row.active-check { 
            border-color: var(--dorado); 
            background: rgba(197,160,89,0.1); 
        }

        .task-row input[type="checkbox"] {
            width: 35px;
            height: 35px;
            accent-color: var(--dorado);
            cursor: pointer;
        }

        #os-notifier { 
            position: fixed; 
            top: 70px; 
            left: 50%; 
            transform: translateX(-50%); 
            padding: 25px 60px; 
            border-radius: 70px; 
            font-weight: 900; 
            display: none; 
            z-index: 2000000; 
            text-align: center; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.9);
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes bounceIn {
            0% { transform: translate(-50%, -100px); opacity: 0; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }

        /* ESTADOS CRÍTICOS Y ALERTAS 
        */
        .critical-pulse { 
            border-left: 10px solid var(--terracota) !important; 
            background: rgba(176,65,62,0.15) !important; 
            animation: pulseWarning 2s infinite; 
        }

        @keyframes pulseWarning { 
            0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } 
        }

    </style>
</head>
<body>

    <div id="os-notifier"></div>

    <div id="login-screen">
        <div class="login-branding">
            <h1>ESCAROLA<span>OS</span></h1>
            <p>Acceso al Terminal de Control</p>
        </div>
        
        <div class="pin-display">
            <div id="p-dot-1" class="pin-dot"></div>
            <div id="p-dot-2" class="pin-dot"></div>
            <div id="p-dot-3" class="pin-dot"></div>
            <div id="p-dot-4" class="pin-dot"></div>
        </div>

        <div class="numpad-container">
            <div class="key-btn" onclick="window.inputDigit('1')">1</div>
            <div class="key-btn" onclick="window.inputDigit('2')">2</div>
            <div class="key-btn" onclick="window.inputDigit('3')">3</div>
            <div class="key-btn" onclick="window.inputDigit('4')">4</div>
            <div class="key-btn" onclick="window.inputDigit('5')">5</div>
            <div class="key-btn" onclick="window.inputDigit('6')">6</div>
            <div class="key-btn" onclick="window.inputDigit('7')">7</div>
            <div class="key-btn" onclick="window.inputDigit('8')">8</div>
            <div class="key-btn" onclick="window.inputDigit('9')">9</div>
            <div class="key-btn action-red" onclick="window.resetLogin()"><i class="fa-solid fa-eraser"></i></div>
            <div class="key-btn" onclick="window.inputDigit('0')">0</div>
            <div class="key-btn action-blue" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></div>
        </div>
    </div>

    <div class="app-container">
        
        <div id="view-finanzas" class="view-layer">
            <div class="hero-balance">
                <span>Capital Neto de Operación</span>
                <h1 id="total-net-wealth">$0.00</h1>
            </div>

            <div class="financial-grid">
                <div class="kpi-card"><span>Caja Física</span><h4 id="kpi-cash">$0.00</h4></div>
                <div class="kpi-card"><span>Fondos Bancarios</span><h4 id="kpi-bank">$0.00</h4></div>
                <div class="kpi-card"><span>Ingresos Totales</span><h4 id="kpi-incomes" style="color:var(--dorado)">$0.00</h4></div>
                <div class="kpi-card"><span>Egresos Totales</span><h4 id="kpi-expenses" style="color:var(--terracota)">$0.00</h4></div>
            </div>
            
            <div class="glass-module">
                <div class="module-header"><h2>Nueva Entrada/Salida</h2><i class="fa-solid fa-piggy-bank"></i></div>
                <div class="field-group">
                    <label>Descripción del Movimiento</label>
                    <input type="text" id="f-desc" placeholder="Ej: Pago de Proveedor Frutas">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px">
                    <div class="field-group">
                        <label>Importe Bruto ($)</label>
                        <input type="number" id="f-amount" step="0.01">
                    </div>
                    <div class="field-group">
                        <label>Canal Destino</label>
                        <select id="f-channel">
                            <option value="CAJA">Caja Efectivo</option>
                            <option value="BANCO">Banco / Digital</option>
                        </select>
                    </div>
                </div>
                <div class="dual-btn-row">
                    <button class="btn-core btn-green" onclick="window.submitFinance('INGRESO')"><i class="fa-solid fa-plus-circle"></i> INGRESO</button>
                    <button class="btn-core btn-red" onclick="window.submitFinance('GASTO')"><i class="fa-solid fa-minus-circle"></i> GASTO</button>
                </div>
            </div>
            <div id="finance-history-list"></div>
        </div>

        <div id="view-reloj" class="view-layer">
            <div class="clock-billboard">
                <h1 id="timer-display">00:00:00</h1>
                <p id="date-display">CARGANDO SISTEMA...</p>
            </div>
            <div class="punch-station">
                <button class="btn-punch btn-in" onclick="window.initPunch('ENTRADA')">
                    <i class="fa-solid fa-unlock-keyhole"></i><span>ENTRADA</span>
                </button>
                <button class="btn-punch btn-out" onclick="window.initPunch('SALIDA')">
                    <i class="fa-solid fa-lock"></i><span>SALIDA</span>
                </button>
            </div>
            <div id="recent-attendance-log" style="margin-top:50px"></div>
        </div>

        <div id="view-insumos" class="view-layer">
            <div class="glass-module">
                <div class="module-header"><h2>Registro de Insumos</h2><i class="fa-solid fa-truck-ramp-box"></i></div>
                <div class="field-group"><label>Nombre del Insumo</label><input type="text" id="i-name"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px">
                    <div class="field-group"><label>Cantidad</label><input type="number" id="i-qty"></div>
                    <div class="field-group"><label>Unidad</label><input type="text" id="i-unit"></div>
                    <div class="field-group"><label>Mínimo</label><input type="number" id="i-min"></div>
                </div>
                <button class="btn-core btn-green" style="width:100%" onclick="window.submitInsumo()">ACTUALIZAR STOCK</button>
            </div>
            <div id="stock-inventory-render"></div>
        </div>

        <div id="view-admin" class="view-layer">
            <div class="glass-module">
                <div class="module-header"><h2>Reporte de Nómina</h2><i class="fa-solid fa-receipt"></i></div>
                <div id="payroll-dynamic-render"></div>
            </div>

            <div class="glass-module">
                <div class="module-header"><h2>Gestión de Personal</h2><i class="fa-solid fa-id-card-clip"></i></div>
                <div class="field-group"><label>Nombre del Colaborador</label><input type="text" id="ad-staff-name"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px">
                    <div class="field-group"><label>PIN de Acceso</label><input type="number" id="ad-staff-pin"></div>
                    <div class="field-group"><label>Sueldo x Hora ($)</label><input type="number" id="ad-staff-wage"></div>
                </div>
                <div class="field-group">
                    <label>Nivel de Privilegios</label>
                    <select id="ad-staff-role">
                        <option value="Staff">Operativo (Solo Reloj)</option>
                        <option value="Socio">Administrador (Acceso Total)</option>
                    </select>
                </div>
                <button class="btn-core btn-green" style="width:100%" onclick="window.registerStaffMember()">DAR DE ALTA</button>
            </div>
            
            <div class="glass-module">
                <div class="module-header"><h2>Tareas de Protocolo</h2><i class="fa-solid fa-clipboard-list"></i></div>
                <div style="display:flex; gap:20px">
                    <input type="text" id="ad-task-new" placeholder="Definir nueva tarea obligatoria..." style="flex:1; padding:25px; border-radius:25px; background:#000; border:2px solid var(--border-light); color:#fff">
                    <button class="btn-core btn-green" style="width:90px; height:75px" onclick="window.addNewProtocolTask()"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="admin-tasks-list" style="margin-top:35px"></div>
            </div>
        </div>
        
        <div id="view-agenda" class="view-layer">
            <div class="glass-module" style="padding: 25px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px">
                    <button onclick="window.changeCalendarMonth(-1)" class="btn-core" style="width:70px; height:70px; background:var(--glass-white); color:#fff"><i class="fa-solid fa-chevron-left"></i></button>
                    <h3 id="calendar-header-title" style="text-transform:uppercase; letter-spacing:6px; font-weight:900; color:var(--dorado)">FEBRERO 2026</h3>
                    <button onclick="window.changeCalendarMonth(1)" class="btn-core" style="width:70px; height:70px; background:var(--glass-white); color:#fff"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div id="calendar-body-grid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:12px"></div>
            </div>
            <div id="agenda-daily-logs"></div>
        </div>

    </div>

    <div id="modal-protocol-exit" class="modal-overlay">
        <div class="modal-window">
            <h2 style="text-align:center; color:var(--dorado); margin-bottom:20px; letter-spacing:2px">PROTOCOLO DE SALIDA</h2>
            <p style="text-align:center; opacity:0.6; font-size:0.9rem; margin-bottom:40px">Es obligatorio marcar todas las tareas para autorizar el fin del turno.</p>
            <div id="checklist-tasks-container" style="max-height:380px; overflow-y:auto; margin-bottom:45px; padding-right:10px"></div>
            <button class="btn-core btn-green" style="width:100%; height:110px; font-size:1.3rem" onclick="window.finalApproveOut()">AUTORIZAR Y FINALIZAR TURNO</button>
        </div>
    </div>

    <nav id="tab-navigation">
        <div class="nav-item" id="nav-finanzas" onclick="window.navigateTo('finanzas')"><i class="fa-solid fa-vault"></i><span>Capital</span></div>
        <div class="nav-item" id="nav-agenda" onclick="window.navigateTo('agenda')"><i class="fa-solid fa-calendar-check"></i><span>Agenda</span></div>
        <div class="nav-item" id="nav-reloj" onclick="window.navigateTo('reloj')"><i class="fa-solid fa-clock-rotate-left"></i><span>Reloj</span></div>
        <div class="nav-item" id="nav-insumos" onclick="window.navigateTo('insumos')"><i class="fa-solid fa-kitchen-set"></i><span>Bodega</span></div>
        <div class="nav-item" id="nav-admin" onclick="window.navigateTo('admin')"><i class="fa-solid fa-user-shield"></i><span>Admin</span></div>
    </nav>

    <script type="module">
        /* ==========================================================================
           NÚCLEO DE INTELIGENCIA OPERATIVA ESCAROLA OS v13.5
           ==========================================================================
        */
        import { db, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, orderBy, limit } from './firebase-config.js';

        // Variables de Estado en Tiempo de Ejecución
        window.activePin = "";
        window.authenticatedUser = null;
        window.currentCalendarDate = new Date();

        /* --- SISTEMA DE AUTENTICACIÓN POR PIN --- */
        window.inputDigit = (digit) => {
            if(window.activePin.length < 4) {
                window.activePin += digit;
                window.updateVisualDots();
                if(window.activePin.length === 4) {
                    setTimeout(window.executeLogin, 300);
                }
            }
        };

        window.resetLogin = () => { 
            window.activePin = ""; 
            window.updateVisualDots(); 
        };

        window.updateVisualDots = () => {
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`p-dot-${i}`);
                if(i <= window.activePin.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            }
        };

        window.executeLogin = async () => {
            try {
                const q = query(collection(db, "usuarios"), where("pin", "==", window.activePin.toString()));
                const snap = await getDocs(q);
                
                if(!snap.empty) {
                    window.authenticatedUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    const loginLayer = document.getElementById('login-screen');
                    loginLayer.style.opacity = '0';
                    setTimeout(() => {
                        loginLayer.style.display = 'none';
                        document.getElementById('tab-navigation').style.display = 'grid';
                        window.startSystemCore();
                    }, 600);
                } else {
                    window.pushNotification("ACCESO DENEGADO", true);
                    window.resetLogin();
                }
            } catch(error) { window.pushNotification("ERROR DE RED", true); }
        };

        /* --- NAVEGACIÓN DE VISTAS --- */
        window.navigateTo = (targetView) => {
            // Protección de Áreas Administrativas
            if((targetView === 'finanzas' || targetView === 'admin') && window.authenticatedUser.rol !== 'Socio') {
                return window.pushNotification("PRIVILEGIOS INSUFICIENTES", true);
            }

            document.querySelectorAll('.view-layer').forEach(view => view.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(`view-${targetView}`).style.display = 'block';
            document.getElementById(`nav-${targetView}`).classList.add('active');
        };

        /* --- MÓDULO CAPITAL: LOGICA FINANCIERA --- */
        window.submitFinance = async (type) => {
            const amountVal = parseFloat(document.getElementById('f-amount').value);
            const descVal = document.getElementById('f-desc').value;
            const channelVal = document.getElementById('f-channel').value;

            if(!amountVal || !descVal) return window.pushNotification("DATOS INCOMPLETOS", true);

            try {
                await addDoc(collection(db, "finanzas"), {
                    monto: amountVal,
                    concepto: descVal,
                    canal: channelVal,
                    tipo: type,
                    timestamp: new Date().toISOString(),
                    autor: window.authenticatedUser.nombre
                });
                window.pushNotification("MOVIMIENTO REGISTRADO");
                document.getElementById('f-amount').value = "";
                document.getElementById('f-desc').value = "";
                window.refreshFinanceDashboard();
            } catch(e) { window.pushNotification("ERROR DE FIREBASE", true); }
        };

        window.refreshFinanceDashboard = async () => {
            const snap = await getDocs(query(collection(db, "finanzas"), orderBy("timestamp", "desc")));
            let cashSum = 0, bankSum = 0, inSum = 0, outSum = 0;
            const historyBox = document.getElementById('finance-history-list');
            historyBox.innerHTML = "<h4 style='opacity:0.3; margin:45px 0 25px; text-transform:uppercase; letter-spacing:2px'>Registro Histórico</h4>";

            snap.forEach(docObj => {
                const data = docObj.data();
                if(data.tipo === 'INGRESO') {
                    inSum += data.monto;
                    if(data.canal === 'CAJA') cashSum += data.monto; else bankSum += data.monto;
                } else {
                    outSum += data.monto;
                    if(data.canal === 'CAJA') cashSum -= data.monto; else bankSum -= data.monto;
                }

                historyBox.innerHTML += `
                    <div class="payroll-item" style="border-left-color:${data.tipo==='INGRESO'?'var(--dorado)':'var(--terracota)'}">
                        <div class="payroll-info">
                            <h3>${data.concepto}</h3>
                            <p>${data.canal} • ${new Date(data.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div class="payroll-data">
                            <h2 style="color:${data.tipo==='INGRESO'?'#fff':'var(--terracota)'}">${data.tipo==='INGRESO'?'+':'-'}$${data.monto.toFixed(2)}</h2>
                            <button class="btn-core" style="height:40px; width:40px; border-radius:12px; margin-top:10px; background:rgba(255,255,255,0.05)" onclick="window.secureDeleteDoc('finanzas','${docObj.id}','refreshFinanceDashboard')"><i class="fa-solid fa-trash-arrow-up" style="font-size:0.9rem"></i></button>
                        </div>
                    </div>`;
            });

            document.getElementById('kpi-cash').innerText = `$${cashSum.toFixed(2)}`;
            document.getElementById('kpi-bank').innerText = `$${bankSum.toFixed(2)}`;
            document.getElementById('kpi-incomes').innerText = `$${inSum.toFixed(2)}`;
            document.getElementById('kpi-expenses').innerText = `$${outSum.toFixed(2)}`;
            document.getElementById('total-net-wealth').innerText = `$${(cashSum + bankSum).toFixed(2)}`;
        };

        /* --- MÓDULO RELOJ: ASISTENCIA Y PROTOCOLOS --- */
        window.initPunch = async (mode) => {
            if(mode === 'SALIDA') {
                const taskSnap = await getDocs(collection(db, "tareas"));
                let taskHtml = "";
                taskSnap.forEach(tDoc => {
                    taskHtml += `
                        <div class="task-row" onclick="this.querySelector('input').click(); this.classList.toggle('active-check')">
                            <input type="checkbox" class="exit-checklist-item">
                            <span style="font-weight:700; color:#fff">${tDoc.data().tarea}</span>
                        </div>`;
                });
                document.getElementById('checklist-tasks-container').innerHTML = taskHtml || "<p style='text-align:center; opacity:0.4'>No hay tareas de protocolo hoy.</p>";
                document.getElementById('modal-protocol-exit').style.display = 'flex';
            } else {
                await window.executePunchRecording('ENTRADA');
            }
        };

        window.finalApproveOut = async () => {
            const checkBoxes = document.querySelectorAll('.exit-checklist-item');
            const allDone = Array.from(checkBoxes).every(b => b.checked);
            
            if(checkBoxes.length > 0 && !allDone) {
                return window.pushNotification("COMPLETE LAS TAREAS", true);
            }
            
            await window.executePunchRecording('SALIDA');
            location.reload(); // Reinicio de sesión por seguridad tras salida
        };

        window.executePunchRecording = async (type) => {
            try {
                await addDoc(collection(db, "asistencias"), {
                    userId: window.authenticatedUser.id,
                    userName: window.authenticatedUser.nombre,
                    type: type,
                    timestamp: new Date().toISOString()
                });
                window.pushNotification("TURNO " + type + " OK");
                window.loadAttendanceHistory();
            } catch(e) { window.pushNotification("FALLO EN RELOJ", true); }
        };

        window.loadAttendanceHistory = async () => {
            const q = query(collection(db, "asistencias"), orderBy("timestamp", "desc"), limit(12));
            const snap = await getDocs(q);
            const box = document.getElementById('recent-attendance-log');
            box.innerHTML = "<h4 style='opacity:0.3; margin-bottom:25px; text-transform:uppercase'>Historial de Reloj</h4>";
            
            snap.forEach(docObj => {
                const entry = docObj.data();
                box.innerHTML += `
                    <div class="payroll-item" style="border-left-color:${entry.type==='ENTRADA'?'var(--dorado)':'var(--terracota)'}">
                        <div class="payroll-info"><h3>${entry.userName}</h3><p>${new Date(entry.timestamp).toLocaleTimeString()}</p></div>
                        <div class="payroll-data"><h2>${entry.type}</h2></div>
                    </div>`;
            });
        };

        /* --- MÓDULO ADMIN: CÁLCULO DE NÓMINA DINÁMICO --- */
        window.processPayrollReport = async () => {
            const userSnap = await getDocs(collection(db, "usuarios"));
            const punchSnap = await getDocs(collection(db, "asistencias"));
            const target = document.getElementById('payroll-dynamic-render');
            target.innerHTML = "";

            userSnap.forEach(uDoc => {
                const userData = uDoc.data();
                const userPunches = punchSnap.docs
                    .map(d => d.data())
                    .filter(p => p.userId === uDoc.id)
                    .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

                let accruedHours = 0;
                for(let i=0; i < userPunches.length; i++) {
                    if(userPunches[i].type === 'ENTRADA' && userPunches[i+1]?.type === 'SALIDA') {
                        const start = new Date(userPunches[i].timestamp);
                        const end = new Date(userPunches[i+1].timestamp);
                        accruedHours += (end - start) / (1000 * 60 * 60);
                        i++; 
                    }
                }

                const totalPay = accruedHours * (userData.sueldo || 0);
                target.innerHTML += `
                    <div class="payroll-item">
                        <div class="payroll-info">
                            <h3>${userData.nombre}</h3>
                            <p>${accruedHours.toFixed(2)} Horas Registradas</p>
                        </div>
                        <div class="payroll-data">
                            <h2>$${totalPay.toFixed(2)}</h2>
                            <small>Sueldo Pendiente</small>
                        </div>
                    </div>`;
            });
        };

        /* --- GESTIÓN DE BODEGA --- */
        window.submitInsumo = async () => {
            const name = document.getElementById('i-name').value;
            const qty = parseFloat(document.getElementById('i-qty').value);
            const min = parseFloat(document.getElementById('i-min').value);
            const unit = document.getElementById('i-unit').value;
            
            if(!name || isNaN(qty)) return window.pushNotification("DATOS ERRÓNEOS", true);
            
            await addDoc(collection(db, "inventario"), { nombre: name, cantidad: qty, minimo: min, unidad: unit });
            window.pushNotification("INVENTARIO ACTUALIZADO");
            window.renderStockList();
        };

        window.renderStockList = async () => {
            const snap = await getDocs(collection(db, "inventario"));
            const container = document.getElementById('stock-inventory-render');
            container.innerHTML = "<h4 style='opacity:0.3; margin:40px 0 25px; text-transform:uppercase'>Existencias en Almacén</h4>";
            
            snap.forEach(docObj => {
                const stock = docObj.data();
                const warning = stock.cantidad <= stock.minimo;
                container.innerHTML += `
                    <div class="payroll-item ${warning ? 'critical-pulse' : ''}">
                        <div class="payroll-info"><h3>${stock.nombre}</h3><p>Stock Mínimo: ${stock.minimo} ${stock.unidad}</p></div>
                        <div class="payroll-data">
                            <h2>${stock.cantidad} <small>${stock.unidad}</small></h2>
                            <button class="btn-core" style="height:40px; width:40px; border-radius:12px; margin-top:10px; background:rgba(255,255,255,0.05)" onclick="window.secureDeleteDoc('inventario','${docObj.id}','renderStockList')"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>`;
            });
        };

        /* --- UTILIDADES CORE --- */
        window.pushNotification = (text, isError = false) => {
            const toast = document.getElementById('os-notifier');
            toast.innerText = text;
            toast.style.display = 'block';
            toast.style.background = isError ? 'var(--terracota)' : 'var(--dorado)';
            toast.style.color = isError ? '#fff' : 'var(--verde-oscuro)';
            setTimeout(() => toast.style.display = 'none', 3800);
        };

        window.secureDeleteDoc = async (colName, docId, callbackName) => {
            if(confirm("¿CONFIRMA ELIMINACIÓN PERMANENTE DE ESTE REGISTRO?")) {
                await deleteDoc(doc(db, colName, docId));
                if(window[callbackName]) window[callbackName]();
            }
        };

        window.startSystemCore = () => {
            window.navigateTo('reloj');
            window.refreshFinanceDashboard();
            window.loadAttendanceHistory();
            window.renderStockList();
            
            if(window.authenticatedUser.rol === 'Socio') {
                window.processPayrollReport();
                window.renderAdminTaskList();
            }

            // Loop de Reloj Maestro
            setInterval(() => {
                const now = new Date();
                document.getElementById('timer-display').innerText = now.toLocaleTimeString('es-MX', {hour12:false});
                document.getElementById('date-display').innerText = now.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'long'}).toUpperCase();
            }, 1000);
        };

        /* --- GESTIÓN DE PERSONAL POR SOCIOS --- */
        window.registerStaffMember = async () => {
            const name = document.getElementById('ad-staff-name').value;
            const pin = document.getElementById('ad-staff-pin').value;
            const wage = document.getElementById('ad-staff-wage').value;
            const role = document.getElementById('ad-staff-role').value;
            
            if(!name || !pin) return;
            await addDoc(collection(db, "usuarios"), { 
                nombre: name, 
                pin: pin.toString(), 
                sueldo: parseFloat(wage), 
                rol: role 
            });
            window.pushNotification("USUARIO ALTA EXITOSA");
            window.processPayrollReport();
        };

        window.addNewProtocolTask = async () => {
            const taskText = document.getElementById('ad-task-new').value;
            if(!taskText) return;
            await addDoc(collection(db, "tareas"), { tarea: taskText });
            document.getElementById('ad-task-new').value = "";
            window.renderAdminTaskList();
        };

        window.renderAdminTaskList = async () => {
            const snap = await getDocs(collection(db, "tareas"));
            const listDiv = document.getElementById('admin-tasks-list');
            listDiv.innerHTML = "";
            snap.forEach(tDoc => {
                listDiv.innerHTML += `
                    <div class="payroll-item">
                        <span>${tDoc.data().tarea}</span>
                        <button class="btn-core" style="height:45px; width:45px; border-radius:15px; background:rgba(176,65,62,0.1); color:var(--terracota)" onclick="window.secureDeleteDoc('tareas','${tDoc.id}','renderAdminTaskList')"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
            });
        };

    </script>
</body>
</html>
