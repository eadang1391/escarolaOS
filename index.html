<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EscarolaOS</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen">
        <div class="login-card"> <img src="logo.png" class="logo-img"> <div class="pin-display">
                <div class="dot" id="dot-0"></div>
                <div class="dot" id="dot-1"></div>
                <div class="dot" id="dot-2"></div>
                <div class="dot" id="dot-3"></div>
            </div>
            
            <div class="keypad">
    <button class="key" onclick="tecleo('1')">1</button>
    <button class="key" onclick="tecleo('2')">2</button>
    <button class="key" onclick="tecleo('3')">3</button>
    
    <button class="key" onclick="tecleo('4')">4</button>
    <button class="key" onclick="tecleo('5')">5</button>
    <button class="key" onclick="tecleo('6')">6</button>
    
    <button class="key" onclick="tecleo('7')">7</button>
    <button class="key" onclick="tecleo('8')">8</button>
    <button class="key" onclick="tecleo('9')">9</button>
    
    <button class="key" onclick="borrar()" style="font-size: 14px; color: var(--terracota);">BORRAR</button>
    <button class="key" onclick="tecleo('0')">0</button>
    <button class="key" style="font-size: 14px; opacity: 0.5;" disabled>‚úîÔ∏è</button>
</div>
        </div>
    </div>
    
    <div id="dashboard">
    <h1 style="color: var(--verde-bosque); margin-bottom: 30px; letter-spacing: 2px;">ESCAROLA<span style="color: var(--dorado);">OS</span></h1>

    <div class="finance-grid">
        <div class="stat-card-premium" id="card-ingresos">
            <div class="card-icon">üí∞</div>
            <div class="card-content">
                <span class="card-label">INGRESOS</span>
                <div class="stat-amount" id="val-ingresos">$0.00</div>
            </div>
            <button class="mini-edit-btn" onclick="abrirEditor('ingresos')">‚úé</button>
        </div>

        <div class="stat-card-premium" id="card-gastos">
            <div class="card-icon">üìâ</div>
            <div class="card-content">
                <span class="card-label">GASTOS</span>
                <div class="stat-amount" id="val-gastos" style="color: var(--terracota);">$0.00</div>
            </div>
            <button class="mini-edit-btn" onclick="abrirEditor('gastos')">‚úé</button>
        </div>

        <div class="stat-card-premium" id="card-utilidad" style="grid-column: span 2; background: linear-gradient(145deg, rgba(197,160,89,0.1), rgba(0,0,0,0.05)); border: 1px solid rgba(197,160,89,0.4);">
            <div class="card-icon" style="background: var(--dorado); color: var(--negro-profundo);">‚ú®</div>
            <div class="card-content">
                <span class="card-label" style="color: var(--dorado); opacity: 1;">UTILIDAD NETA</span>
                <div class="stat-amount" id="val-utilidad" style="font-size: 1.8rem;">$0.00</div>
            </div>
        </div>
    </div>

    <div id="seccion-admin" class="stat-card-premium" style="flex-direction: column; align-items: stretch; margin-top: 25px; padding: 0; overflow: hidden;">
        <div style="background: rgba(197, 160, 89, 0.1); padding: 15px; border-bottom: 1px solid rgba(197, 160, 89, 0.2);">
            <h3 style="color: var(--dorado); margin: 0; font-size: 1rem; display: flex; align-items: center; gap: 10px;">
                <span>üë•</span> GESTI√ìN DE COLABORADORES
            </h3>
        </div>

        <div style="padding: 20px;">
            <div class="input-group">
                <label>NOMBRE COMPLETO</label>
                <input type="text" id="reg-nombre" placeholder="Ej. Juan P√©rez" class="input-app">
            </div>

            <div class="input-group">
                <label>PIN DE ACCESO (4 D√çGITOS)</label>
                <input type="number" id="reg-pin" placeholder="0 0 0 0" class="input-app" maxlength="4">
            </div>
            
            <label style="color: var(--dorado); font-size: 0.65rem; letter-spacing: 1px; font-weight: bold; display: block; margin-bottom: 12px; text-transform: uppercase;">ASIGNAR PUESTO / ROL</label>
            <div id="selector-roles" class="rol-container">
                <button class="rol-btn" onclick="seleccionarRol('Socio', this)">üëë Socio</button>
                <button class="rol-btn" onclick="seleccionarRol('Chef', this)">üë®‚Äçüç≥ Chef</button>
                <button class="rol-btn" onclick="seleccionarRol('Barista', this)">‚òï Barista</button>
                <button class="rol-btn" onclick="seleccionarRol('Barman', this)">üç∏ Barman</button>
                <button class="rol-btn" onclick="seleccionarRol('Staff', this)">üèÉ Staff</button>
            </div>
            
            <button onclick="guardarNuevoUsuario()" class="btn-principal">
                GUARDAR EN EL SISTEMA
            </button>

            <div style="margin-top: 30px;">
                <label style="color: var(--cantera); font-size: 0.7rem; opacity: 0.5; letter-spacing: 1px;">PERSONAL REGISTRADO</label>
                <div id="lista-personal-db" style="margin-top: 10px;">
                    </div>
            </div>
        </div>
    </div>
</div>

    <script type="module">
    // 1. IMPORTACIONES
    import { 
        db, collection, addDoc, getDocs, query, where, doc, getDoc, updateDoc, deleteDoc 
    } from './firebase-config.js';

    // 2. VARIABLES DE ESTADO
    let pinIngresado = "";
    let rolSeleccionado = "";

    // 3. SISTEMA DE NOTIFICACIONES
    window.notificar = (mensaje, esError = false) => {
        const aviso = document.createElement("div");
        aviso.className = "toast";
        if(esError) aviso.style.backgroundColor = "var(--terracota)";
        aviso.innerText = mensaje;
        document.body.appendChild(aviso);
        setTimeout(() => {
            aviso.style.opacity = "0";
            aviso.style.transition = "0.5s";
            setTimeout(() => aviso.remove(), 500);
        }, 3000);
    };

    // 4. L√ìGICA DEL PINPAD
    window.tecleo = (num) => {
        if (pinIngresado.length < 4) {
            pinIngresado += num;
            actualizarInterfaz();
            if (pinIngresado.length === 4) {
                setTimeout(verificarAcceso, 200);
            }
        }
    };

    window.borrar = () => {
        pinIngresado = "";
        actualizarInterfaz();
    };

    function actualizarInterfaz() {
        for (let i = 0; i < 4; i++) {
            const dot = document.getElementById(`dot-${i}`);
            if(dot) dot.classList.toggle('filled', i < pinIngresado.length);
        }
    }

    // 5. SELECCI√ìN DE ROLES
    window.seleccionarRol = (rol, elemento) => {
        document.querySelectorAll('.rol-btn').forEach(btn => btn.classList.remove('active'));
        elemento.classList.add('active');
        rolSeleccionado = rol;
    };

    // 6. GESTI√ìN DE PERSONAL
    window.guardarNuevoUsuario = async () => {
        const nombre = document.getElementById('reg-nombre').value;
        const pin = document.getElementById('reg-pin').value;

        if (!nombre || pin.length !== 4 || !rolSeleccionado) {
            window.notificar("‚ö†Ô∏è Completa todos los datos", true);
            return;
        }

        try {
            await addDoc(collection(db, "usuarios"), {
                nombre, pin, rol: rolSeleccionado, creado: new Date().toISOString()
            });
            window.notificar(`‚úÖ ${nombre} registrado`);
            document.getElementById('reg-nombre').value = "";
            document.getElementById('reg-pin').value = "";
            document.querySelectorAll('.rol-btn').forEach(btn => btn.classList.remove('active'));
            rolSeleccionado = "";
            window.cargarPersonal();
        } catch (error) {
            window.notificar("‚ùå Error al guardar", true);
        }
    };

    window.cargarPersonal = async () => {
        const listaContenedor = document.getElementById('lista-personal-db');
        if (!listaContenedor) return;
        try {
            const snap = await getDocs(collection(db, "usuarios"));
            listaContenedor.innerHTML = "";
            snap.forEach((docSnap) => {
                const u = docSnap.data();
                listaContenedor.innerHTML += `
                    <div class="user-row">
                        <div><strong>${u.nombre}</strong><br><small>${u.rol}</small></div>
                        <button onclick="eliminarUsuario('${docSnap.id}')" style="background:none; border:none; color:var(--terracota); cursor:pointer;">‚úï</button>
                    </div>`;
            });
        } catch (e) { console.error(e); }
    };

    window.eliminarUsuario = async (id) => {
        if (confirm("¬øEliminar colaborador?")) {
            await deleteDoc(doc(db, "usuarios", id));
            window.notificar("Eliminado");
            window.cargarPersonal();
        }
    };

    // 7. FINANZAS
    window.actualizarFinanzasUI = (ingresos, gastos) => {
        const utilidad = ingresos - gastos;
        if(document.getElementById('val-ingresos')) {
            document.getElementById('val-ingresos').innerText = `$${ingresos.toLocaleString()}`;
            document.getElementById('val-gastos').innerText = `$${gastos.toLocaleString()}`;
            document.getElementById('val-utilidad').innerText = `$${utilidad.toLocaleString()}`;
            document.getElementById('val-utilidad').style.color = utilidad < 0 ? 'var(--terracota)' : 'var(--dorado)';
        }
    };

    window.calcularFinanzasReales = async () => {
        try {
            let inc = 0, gas = 0;
            const qI = await getDocs(collection(db, "pagos"));
            qI.forEach(d => inc += Number(d.data().monto || 0));
            const qG = await getDocs(collection(db, "gastos"));
            qG.forEach(d => gas += Number(d.data().monto || 0));
            window.actualizarFinanzasUI(inc, gas);
        } catch (e) { console.error(e); }
    };

    // 8. ACCESO
    async function verificarAcceso() {
        try {
            const q = query(collection(db, "usuarios"), where("pin", "==", pinIngresado));
            const snap = await getDocs(q);

            if (!snap.empty) {
                const usuario = snap.docs[0].data();
                window.notificar("Bienvenido " + usuario.nombre);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                if (usuario.rol === 'Socio') {
                    window.cargarPersonal();
                    window.calcularFinanzasReales();
                    const admin = document.getElementById('seccion-admin');
                    if(admin) admin.style.display = 'block';
                } else {
                    const admin = document.getElementById('seccion-admin');
                    if(admin) admin.style.display = 'none';
                }
            } else {
                window.notificar("PIN Incorrecto", true);
                window.borrar();
            }
        } catch (e) {
            window.notificar("Error de conexi√≥n", true);
            window.borrar();
        }
    }
</script>

</script>
</script>
</body>
</html>






















