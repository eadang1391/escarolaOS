<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EscarolaOS v13.6 - Enterprise Comprehensive</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ==========================================================================
           ESCAROLA OS - SISTEMA DE DISEÑO DE ALTA DENSIDAD
           ========================================================================== */
        :root {
            --verde-bosque: #1b3022;
            --verde-oscuro: #14241a;
            --terracota: #b0413e;
            --cantera: #d9d4c7;
            --dorado: #c5a059;
            --negro: #0a0a0a;
            --glass-white: rgba(255, 255, 255, 0.05);
            --glass-dark: rgba(0, 0, 0, 0.7);
            --border-light: rgba(217, 212, 199, 0.15);
            --shadow-3d: 0 40px 80px rgba(0,0,0,0.8);
            --radius-max: 60px;
            --radius-mid: 30px;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* RESET DE INTERFAZ */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--verde-bosque); color: var(--cantera); height: 100vh; overflow: hidden; -webkit-font-smoothing: antialiased; }

        /* --------------------------------------------------------------------------
           CAPA DE SEGURIDAD (PINPAD)
           -------------------------------------------------------------------------- */
        #login-screen { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at center, #1b3022 0%, #050505 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 999999; transition: opacity 0.8s ease; 
        }
        .login-branding { text-align: center; margin-bottom: 50px; }
        .login-branding h1 { font-size: 3.5rem; letter-spacing: 15px; color: #fff; font-weight: 900; }
        .login-branding h1 span { color: var(--dorado); }
        .pin-display { display: flex; gap: 25px; margin-bottom: 50px; }
        .pin-dot { width: 22px; height: 22px; border: 3px solid var(--dorado); border-radius: 50%; transition: 0.3s; }
        .pin-dot.filled { background: var(--dorado); box-shadow: 0 0 25px var(--dorado); transform: scale(1.3); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; max-width: 320px; }
        .key { aspect-ratio: 1; border-radius: 50%; border: 1px solid var(--border-light); background: var(--glass-white); color: var(--dorado); font-size: 2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .key:active { background: var(--dorado); color: var(--verde-oscuro); transform: scale(0.9); }

        /* --------------------------------------------------------------------------
           ESTRUCTURA DE VISTAS
           -------------------------------------------------------------------------- */
        .app-shell { position: relative; height: 100vh; width: 100%; }
        .view-frame { display: none; height: 100vh; width: 100%; overflow-y: auto; padding: 30px; padding-bottom: 220px; scrollbar-width: none; }
        .view-frame::-webkit-scrollbar { display: none; }

        .module-card { 
            background: var(--verde-oscuro); border-radius: var(--radius-mid); 
            padding: 35px; margin-bottom: 30px; border: 1px solid var(--border-light); 
            box-shadow: var(--shadow-3d); position: relative;
        }

        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; padding-left: 15px; border-left: 5px solid var(--dorado); }
        .section-header h2 { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 4px; color: var(--dorado); font-weight: 900; }

        /* --------------------------------------------------------------------------
           MÓDULO: CAPITAL & FINANZAS
           -------------------------------------------------------------------------- */
        .capital-hero { text-align: center; padding: 70px 20px; background: #000; border-radius: var(--radius-max); border-bottom: 5px solid var(--dorado); margin-bottom: 40px; }
        .capital-hero h1 { font-size: 5rem; font-weight: 900; color: #fff; letter-spacing: -3px; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .kpi-box { background: var(--glass-white); padding: 25px; border-radius: 30px; text-align: center; border: 1px solid var(--border-light); }
        .kpi-box span { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.5; }
        .kpi-box h4 { font-size: 1.8rem; margin-top: 10px; color: #fff; }

        /* --------------------------------------------------------------------------
           MÓDULO: AGENDA & RESERVAS
           -------------------------------------------------------------------------- */
        .calendar-wrap { background: var(--glass-white); border-radius: 40px; padding: 25px; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 15px; background: rgba(0,0,0,0.3); font-weight: 700; cursor: pointer; font-size: 0.9rem; transition: 0.3s; position: relative; }
        .cal-day.today { border: 2px solid var(--dorado); color: var(--dorado); }
        .cal-day.has-event::after { content: ''; position: absolute; bottom: 5px; width: 6px; height: 6px; background: var(--terracota); border-radius: 50%; }
        .cal-day:active { transform: scale(0.9); background: var(--dorado); color: #000; }

        /* --------------------------------------------------------------------------
           MÓDULO: BODEGA, RECETARIO & COSTEO
           -------------------------------------------------------------------------- */
        .recipe-item { background: var(--glass-white); padding: 25px; border-radius: 25px; margin-bottom: 15px; border-left: 6px solid #59a5c5; }
        .cost-tag { background: var(--dorado); color: #000; padding: 5px 12px; border-radius: 10px; font-weight: 900; font-size: 0.8rem; }
        .ingredient-list { margin-top: 15px; padding-left: 20px; font-size: 0.85rem; opacity: 0.7; }

        /* --------------------------------------------------------------------------
           MÓDULO: RELOJ & ASISTENCIA (SOCIOS SOLAMENTE)
           -------------------------------------------------------------------------- */
        .clock-billboard { text-align: center; padding: 80px 15px; background: radial-gradient(circle, #233d2c 0%, #000 100%); border-radius: var(--radius-max); border: 3px solid var(--dorado); margin-bottom: 40px; }
        #clock-time { font-size: 7rem; font-weight: 900; color: #fff; line-height: 1; }
        .punch-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .p-btn { height: 220px; border-radius: 50px; border: none; font-weight: 900; letter-spacing: 3px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .p-btn i { font-size: 4rem; }
        .p-in { background: var(--dorado); color: var(--verde-oscuro); }
        .p-out { background: var(--terracota); color: #fff; }
        .p-btn:active { transform: scale(0.9); }

        /* --------------------------------------------------------------------------
           ADMIN & PAGOS
           -------------------------------------------------------------------------- */
        .staff-card { background: var(--glass-white); padding: 25px; border-radius: 30px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .staff-info b { font-size: 1.2rem; color: #fff; display: block; }
        .staff-info span { font-size: 0.75rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; }
        .pay-btn { background: #4caf50; color: #fff; border: none; padding: 15px 25px; border-radius: 20px; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .pay-btn:active { transform: scale(0.95); }

        /* --------------------------------------------------------------------------
           NAVEGACIÓN (ESTILO TAB BAR)
           -------------------------------------------------------------------------- */
        #main-nav { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            width: 94%; max-width: 700px; background: rgba(5,5,5,0.95); 
            border-radius: 70px; border: 1.5px solid var(--dorado); 
            display: none; grid-template-columns: repeat(5, 1fr); padding: 22px 10px; 
            z-index: 99999; backdrop-filter: blur(30px); box-shadow: 0 40px 100px rgba(0,0,0,0.9);
            padding-bottom: calc(22px + var(--safe-bottom));
        }
        .nav-unit { text-align: center; color: var(--cantera); opacity: 0.3; transition: 0.4s; }
        .nav-unit.active { opacity: 1; color: var(--dorado); transform: translateY(-15px); }
        .nav-unit i { font-size: 1.8rem; display: block; margin-bottom: 8px; }
        .nav-unit span { font-size: 0.6rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; }

        /* MODALES */
        .modal-full { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 1000000; align-items: center; justify-content: center; padding: 25px; }
        .modal-box { width: 100%; max-width: 550px; background: var(--verde-oscuro); border-radius: 50px; padding: 50px; border: 3px solid var(--dorado); }

        .form-row { margin-bottom: 20px; }
        .form-row label { display: block; font-size: 0.7rem; font-weight: 900; color: var(--dorado); text-transform: uppercase; margin: 0 0 10px 15px; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 20px; border-radius: 20px; background: #000; border: 1px solid var(--border-light); color: #fff; font-size: 1rem; }

        #toast { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); padding: 20px 50px; border-radius: 50px; font-weight: 900; display: none; z-index: 2000000; text-align: center; text-transform: uppercase; }

        .task-line { display: flex; align-items: center; gap: 15px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 20px; margin-bottom: 10px; }
        .task-line input { width: 25px; height: 25px; accent-color: var(--dorado); }

    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="login-screen">
        <div class="login-branding">
            <h1>ESCAROLA<span>OS</span></h1>
            <p style="letter-spacing: 5px; color: var(--dorado); font-weight: 800; font-size: 0.7rem; margin-top: 15px; opacity: 0.7;">ENTERPRISE MANAGEMENT SYSTEM</p>
        </div>
        <div class="pin-display">
            <div id="d-1" class="pin-dot"></div>
            <div id="d-2" class="pin-dot"></div>
            <div id="d-3" class="pin-dot"></div>
            <div id="d-4" class="pin-dot"></div>
        </div>
        <div class="numpad">
            <div class="key" onclick="window.press('1')">1</div>
            <div class="key" onclick="window.press('2')">2</div>
            <div class="key" onclick="window.press('3')">3</div>
            <div class="key" onclick="window.press('4')">4</div>
            <div class="key" onclick="window.press('5')">5</div>
            <div class="key" onclick="window.press('6')">6</div>
            <div class="key" onclick="window.press('7')">7</div>
            <div class="key" onclick="window.press('8')">8</div>
            <div class="key" onclick="window.press('9')">9</div>
            <div class="key" onclick="window.del()" style="color:var(--terracota)"><i class="fa-solid fa-delete-left"></i></div>
            <div class="key" onclick="window.press('0')">0</div>
            <div class="key" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></div>
        </div>
    </div>

    <div class="app-shell">
        
        <div id="view-finanzas" class="view-frame">
            <div class="capital-hero">
                <span style="opacity:0.5; text-transform:uppercase; letter-spacing:5px; font-weight:800; font-size:0.8rem">Capital Operativo Total</span>
                <h1 id="net-wealth">$0.00</h1>
            </div>
            <div class="kpi-grid">
                <div class="kpi-box"><span>Caja</span><h4 id="box-cash">$0.00</h4></div>
                <div class="kpi-box"><span>Banco</span><h4 id="box-bank">$0.00</h4></div>
                <div class="kpi-box"><span>Ventas</span><h4 id="box-incomes" style="color:var(--dorado)">$0.00</h4></div>
                <div class="kpi-box"><span>Gastos</span><h4 id="box-expenses" style="color:var(--terracota)">$0.00</h4></div>
            </div>
            
            <div class="module-card">
                <div class="section-header"><h2>Transacción de Capital</h2><i class="fa-solid fa-money-bill-transfer"></i></div>
                <div class="form-row"><label>Concepto</label><input type="text" id="f-desc" placeholder="Ej: Pago CFE o Venta POS"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                    <div class="form-row"><label>Monto ($)</label><input type="number" id="f-val"></div>
                    <div class="form-row">
                        <label>Canal</label>
                        <select id="f-acc"><option value="CAJA">Caja Efectivo</option><option value="BANCO">Banco / Terminal</option></select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
                    <button class="pay-btn" style="height:80px; background:var(--dorado); color:#000" onclick="window.addFinance('INGRESO')">INGRESO</button>
                    <button class="pay-btn" style="height:80px; background:var(--terracota)" onclick="window.addFinance('GASTO')">GASTO</button>
                </div>
            </div>
            <div id="finance-log"></div>
        </div>

        <div id="view-agenda" class="view-frame">
            <div class="module-card">
                <div class="cal-header">
                    <button onclick="window.changeMon(-1)" style="background:none; border:none; color:#fff"><i class="fa-solid fa-chevron-left fa-xl"></i></button>
                    <h2 id="cal-title" style="color:var(--dorado); letter-spacing:4px">MARZO 2026</h2>
                    <button onclick="window.changeMon(1)" style="background:none; border:none; color:#fff"><i class="fa-solid fa-chevron-right fa-xl"></i></button>
                </div>
                <div class="cal-grid" id="cal-grid"></div>
            </div>
            <div class="module-card">
                <div class="section-header"><h2>Nueva Reserva / Evento</h2></div>
                <div class="form-row"><input type="text" id="ag-title" placeholder="Nombre del cliente o evento"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <input type="time" id="ag-time" style="padding:15px; border-radius:15px; background:#000; border:1px solid var(--border-light); color:#fff">
                    <button class="pay-btn" onclick="window.addAgenda()">RESERVAR</button>
                </div>
            </div>
            <div id="agenda-list"></div>
        </div>

        <div id="view-reloj" class="view-frame">
            <div class="clock-billboard">
                <h1 id="clock-time">00:00:00</h1>
                <p id="clock-date" style="color:var(--dorado); font-weight:800; letter-spacing:5px; margin-top:20px; text-transform:uppercase"></p>
            </div>
            <div class="punch-btns">
                <button class="p-btn p-in" onclick="window.doPunch('ENTRADA')"><i class="fa-solid fa-sign-in-alt"></i>ENTRADA</button>
                <button class="p-btn p-out" onclick="window.doPunch('SALIDA')"><i class="fa-solid fa-sign-out-alt"></i>SALIDA</button>
            </div>
            <div id="socio-punch-view" style="margin-top:50px"></div>
        </div>

        <div id="view-insumos" class="view-frame">
            <div class="module-card">
                <div class="section-header"><h2>Gestión de Recetario</h2><i class="fa-solid fa-utensils"></i></div>
                <div class="form-row"><label>Nombre del Platillo/Bebida</label><input type="text" id="r-name"></div>
                <div class="form-row"><label>Ingredientes y Cantidades</label><textarea id="r-ing" rows="3" placeholder="Ej: 200g Harina, 2 Huevos..."></textarea></div>
                <div class="form-row"><label>Costo de Insumos ($)</label><input type="number" id="r-cost"></div>
                <button class="pay-btn" style="width:100%" onclick="window.addRecipe()">GUARDAR EN RECETARIO</button>
            </div>
            <div id="recipe-list"></div>
            
            <div class="module-card" style="margin-top:50px">
                <div class="section-header"><h2>Control de Inventario Bruto</h2><i class="fa-solid fa-boxes-stacked"></i></div>
                <div class="form-row"><label>Artículo</label><input type="text" id="i-name"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px">
                    <div class="form-row"><label>Existencia</label><input type="number" id="i-qty"></div>
                    <div class="form-row"><label>Unidad</label><input type="text" id="i-unit"></div>
                    <div class="form-row"><label>Mínimo</label><input type="number" id="i-min"></div>
                </div>
                <button class="pay-btn" style="width:100%; background:#59a5c5" onclick="window.addStock()">ACTUALIZAR STOCK</button>
            </div>
            <div id="stock-list"></div>
        </div>

        <div id="view-admin" class="view-frame">
            <div class="module-card">
                <div class="section-header"><h2>Nómina Dinámica & Pagos</h2><i class="fa-solid fa-calculator"></i></div>
                <div id="payroll-render"></div>
            </div>
            
            <div class="module-card">
                <div class="section-header"><h2>Gestión de Usuarios</h2><i class="fa-solid fa-users-gear"></i></div>
                <div class="form-row"><label>Nombre Completo</label><input type="text" id="ad-name"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                    <div class="form-row"><label>PIN Acceso</label><input type="number" id="ad-pin"></div>
                    <div class="form-row"><label>Sueldo x Hora</label><input type="number" id="ad-wage"></div>
                </div>
                <div class="form-row">
                    <label>Rol de Sistema</label>
                    <select id="ad-role">
                        <option value="Socio">Socio (Acceso Total)</option>
                        <option value="Chef">Chef</option>
                        <option value="Barista">Barista</option>
                        <option value="Barman">Barman</option>
                        <option value="Staff">Staff General</option>
                    </select>
                </div>
                <button class="pay-btn" style="width:100%" onclick="window.addUser()">CREAR USUARIO</button>
            </div>

            <div class="module-card">
                <div class="section-header"><h2>Checklist de Limpieza Obligatorio</h2></div>
                <div style="display:flex; gap:15px">
                    <input type="text" id="ad-task" placeholder="Nueva tarea..." style="flex:1; padding:15px; border-radius:15px; background:#000; border:1px solid var(--border-light); color:#fff">
                    <button class="pay-btn" style="width:70px" onclick="window.addTask()"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="admin-tasks" style="margin-top:20px"></div>
            </div>
            
            <div class="module-card">
                <div class="section-header"><h2>Historial de Pagos Realizados</h2></div>
                <div id="payment-history"></div>
            </div>
        </div>

    </div>

    <div id="modal-exit" class="modal-full">
        <div class="modal-box">
            <h2 style="text-align:center; color:var(--dorado); margin-bottom:15px">PROTOCOLO DE SALIDA</h2>
            <p style="text-align:center; opacity:0.6; font-size:0.8rem; margin-bottom:30px">Es obligatorio marcar al menos una tarea realizada en este turno.</p>
            <div id="exit-checklist" style="max-height:300px; overflow-y:auto; margin-bottom:30px"></div>
            <button class="pay-btn" style="width:100%; height:80px; font-size:1.2rem" onclick="window.finishPunchOut()">CONFIRMAR Y SALIR</button>
        </div>
    </div>

    <nav id="main-nav">
        <div class="nav-unit" id="n-finanzas" onclick="window.go('finanzas')"><i class="fa-solid fa-vault"></i><span>Capital</span></div>
        <div class="nav-unit" id="n-agenda" onclick="window.go('agenda')"><i class="fa-solid fa-calendar-alt"></i><span>Agenda</span></div>
        <div class="nav-unit" id="n-reloj" onclick="window.go('reloj')"><i class="fa-solid fa-fingerprint"></i><span>Reloj</span></div>
        <div class="nav-unit" id="n-insumos" onclick="window.go('insumos')"><i class="fa-solid fa-kitchen-set"></i><span>Bodega</span></div>
        <div class="nav-unit" id="n-admin" onclick="window.go('admin')"><i class="fa-solid fa-user-shield"></i><span>Admin</span></div>
    </nav>

    <script type="module">
        import { db, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, orderBy, limit } from './firebase-config.js';

        window.pin = "";
        window.user = null;
        window.calDate = new Date();

        /* --- ACCESO --- */
        window.press = (n) => {
            if(window.pin.length < 4) {
                window.pin += n;
                window.upDots();
                if(window.pin.length === 4) setTimeout(window.auth, 300);
            }
        };

        window.del = () => { window.pin = ""; window.upDots(); };

        window.upDots = () => {
            for(let i=1; i<=4; i++) {
                document.getElementById(`d-${i}`).classList.toggle('filled', i <= window.pin.length);
            }
        };

        window.auth = async () => {
            const q = query(collection(db, "usuarios"), where("pin", "==", window.pin));
            const snap = await getDocs(q);
            if(!snap.empty) {
                window.user = { id: snap.docs[0].id, ...snap.docs[0].data() };
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-nav').style.display = 'grid';
                window.boot();
            } else {
                window.show("PIN INCORRECTO", true);
                window.del();
            }
        };

        /* --- NAVEGACIÓN --- */
        window.go = (v) => {
            if((v === 'finanzas' || v === 'admin') && window.user.rol !== 'Socio') {
                return window.show("ACCESO RESTRINGIDO", true);
            }
            document.querySelectorAll('.view-frame').forEach(f => f.style.display = 'none');
            document.querySelectorAll('.nav-unit').forEach(u => u.classList.remove('active'));
            document.getElementById(`view-${v}`).style.display = 'block';
            document.getElementById(`n-${v}`).classList.add('active');
        };

        /* --- FINANZAS --- */
        window.addFinance = async (t) => {
            const val = parseFloat(document.getElementById('f-val').value);
            const des = document.getElementById('f-desc').value;
            if(!val || !des) return window.show("DATOS INCOMPLETOS", true);
            await addDoc(collection(db, "finanzas"), { monto: val, concepto: des, canal: document.getElementById('f-acc').value, tipo: t, fecha: new Date().toISOString() });
            window.show("REGISTRADO");
            window.loadFin();
        };

        window.loadFin = async () => {
            const snap = await getDocs(query(collection(db, "finanzas"), orderBy("fecha", "desc")));
            let cj=0, bn=0, inc=0, gas=0;
            const log = document.getElementById('finance-log');
            log.innerHTML = "";
            snap.forEach(d => {
                const f = d.data();
                if(f.tipo === 'INGRESO') {
                    inc += f.monto;
                    if(f.canal === 'CAJA') cj += f.monto; else bn += f.monto;
                } else {
                    gas += f.monto;
                    if(f.canal === 'CAJA') cj -= f.monto; else bn -= f.monto;
                }
                log.innerHTML += `<div class="staff-card" style="border-left:5px solid ${f.tipo==='INGRESO'?'var(--dorado)':'var(--terracota)'}">
                    <div class="staff-info"><b>${f.concepto}</b><span>${f.canal} • ${new Date(f.fecha).toLocaleDateString()}</span></div>
                    <div style="text-align:right"><h3 style="color:${f.tipo==='INGRESO'?'#fff':'var(--terracota)'}">${f.tipo==='INGRESO'?'+':'-'}$${f.monto}</h3></div>
                </div>`;
            });
            document.getElementById('box-cash').innerText = `$${cj}`;
            document.getElementById('box-bank').innerText = `$${bn}`;
            document.getElementById('box-incomes').innerText = `$${inc}`;
            document.getElementById('box-expenses').innerText = `$${gas}`;
            document.getElementById('net-wealth').innerText = `$${cj + bn}`;
        };

        /* --- AGENDA --- */
        window.changeMon = (dir) => {
            window.calDate.setMonth(window.calDate.getMonth() + dir);
            window.drawCal();
        };

        window.drawCal = async () => {
            const grid = document.getElementById('cal-grid');
            const title = document.getElementById('cal-title');
            const date = window.calDate;
            title.innerText = date.toLocaleDateString('es-MX', {month:'long', year:'numeric'}).toUpperCase();
            
            grid.innerHTML = "";
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            
            for(let i=1; i<=lastDay; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'cal-day';
                dayDiv.innerText = i;
                dayDiv.onclick = () => window.loadAgendaDay(i);
                grid.appendChild(dayDiv);
            }
        };

        window.addAgenda = async () => {
            const tit = document.getElementById('ag-title').value;
            const tim = document.getElementById('ag-time').value;
            const day = new Date().getDate(); // Simplificado para el ejemplo
            await addDoc(collection(db, "agenda"), { titulo: tit, hora: tim, fecha: window.calDate.toISOString(), dia: day });
            window.show("RESERVA GUARDADA");
            window.loadAgendaDay(day);
        };

        window.loadAgendaDay = async (d) => {
            const snap = await getDocs(query(collection(db, "agenda"), where("dia", "==", d)));
            const list = document.getElementById('agenda-list');
            list.innerHTML = `<h4>Eventos del día ${d}</h4>`;
            snap.forEach(doc => {
                const ev = doc.data();
                list.innerHTML += `<div class="staff-card"><b>${ev.hora} - ${ev.titulo}</b></div>`;
            });
        };

        /* --- RELOJ & PROTOCOLO --- */
        window.doPunch = async (t) => {
            if(t === 'SALIDA') {
                const snap = await getDocs(collection(db, "tareas"));
                let html = "";
                snap.forEach(d => {
                    html += `<div class="task-line"><input type="checkbox" class="exit-chk"><span>${d.data().tarea}</span></div>`;
                });
                document.getElementById('exit-checklist').innerHTML = html;
                document.getElementById('modal-exit').style.display = 'flex';
            } else {
                window.savePunch('ENTRADA');
            }
        };

        window.finishPunchOut = async () => {
            const chks = document.querySelectorAll('.exit-chk');
            const oneChecked = Array.from(chks).some(c => c.checked);
            if(!oneChecked && chks.length > 0) return window.show("MARCA AL MENOS UNA TAREA", true);
            await window.savePunch('SALIDA');
            location.reload();
        };

        window.savePunch = async (t) => {
            await addDoc(collection(db, "asistencias"), { uid: window.user.id, nombre: window.user.nombre, tipo: t, fecha: new Date().toISOString() });
            window.show("RELOJ: " + t);
            if(window.user.rol === 'Socio') window.loadPunchHistory();
        };

        window.loadPunchHistory = async () => {
            const snap = await getDocs(query(collection(db, "asistencias"), orderBy("fecha", "desc"), limit(10)));
            const box = document.getElementById('socio-punch-view');
            box.innerHTML = "<h4>Últimos movimientos de personal</h4>";
            snap.forEach(d => {
                const p = d.data();
                box.innerHTML += `<div class="staff-card"><b>${p.nombre}</b><span>${p.tipo} - ${new Date(p.fecha).toLocaleTimeString()}</span></div>`;
            });
        };

        /* --- BODEGA & RECETARIO --- */
        window.addRecipe = async () => {
            const n = document.getElementById('r-name').value;
            const i = document.getElementById('r-ing').value;
            const c = document.getElementById('r-cost').value;
            await addDoc(collection(db, "recetas"), { nombre: n, ingredientes: i, costo: parseFloat(c) });
            window.show("PLATILLO GUARDADO");
            window.loadRecipes();
        };

        window.loadRecipes = async () => {
            const snap = await getDocs(collection(db, "recetas"));
            const list = document.getElementById('recipe-list');
            list.innerHTML = "<h4>Catálogo de Platillos y Costeo</h4>";
            snap.forEach(d => {
                const r = d.data();
                list.innerHTML += `<div class="recipe-item">
                    <div style="display:flex; justify-content:space-between"><b>${r.nombre}</b><span class="cost-tag">$${r.costo}</span></div>
                    <div class="ingredient-list">${r.ingredientes}</div>
                </div>`;
            });
        };

        window.addStock = async () => {
            const n = document.getElementById('i-name').value;
            const q = document.getElementById('i-qty').value;
            const u = document.getElementById('i-unit').value;
            const m = document.getElementById('i-min').value;
            await addDoc(collection(db, "inventario"), { nombre: n, cantidad: parseFloat(q), unidad: u, minimo: parseFloat(m) });
            window.show("STOCK ACTUALIZADO");
            window.loadStock();
        };

        window.loadStock = async () => {
            const snap = await getDocs(collection(db, "inventario"));
            const list = document.getElementById('stock-list');
            list.innerHTML = "<h4>Existencias en Bodega</h4>";
            snap.forEach(d => {
                const s = d.data();
                const alert = s.cantidad <= s.minimo ? 'border-left: 6px solid var(--terracota)' : '';
                list.innerHTML += `<div class="staff-card" style="${alert}">
                    <div class="staff-info"><b>${s.nombre}</b><span>Mín: ${s.minimo} ${s.unidad}</span></div>
                    <h3>${s.cantidad} ${s.unidad}</h3>
                </div>`;
            });
        };

        /* --- ADMIN: NÓMINA & PAGOS --- */
        window.addUser = async () => {
            const n = document.getElementById('ad-name').value;
            const p = document.getElementById('ad-pin').value;
            const w = document.getElementById('ad-wage').value;
            const r = document.getElementById('ad-role').value;
            await addDoc(collection(db, "usuarios"), { nombre: n, pin: p, sueldo: parseFloat(w), rol: r });
            window.show("USUARIO CREADO");
            window.loadPayroll();
        };

        window.loadPayroll = async () => {
            const uSnap = await getDocs(collection(db, "usuarios"));
            const pSnap = await getDocs(collection(db, "asistencias"));
            const render = document.getElementById('payroll-render');
            render.innerHTML = "";
            
            uSnap.forEach(u => {
                const ud = u.data();
                const punches = pSnap.docs.map(d => d.data()).filter(p => p.uid === u.id).sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
                let hrs = 0;
                for(let i=0; i<punches.length; i++){
                    if(punches[i].tipo === 'ENTRADA' && punches[i+1]?.tipo === 'SALIDA'){
                        hrs += (new Date(punches[i+1].fecha) - new Date(punches[i].fecha)) / 3600000;
                        i++;
                    }
                }
                const total = hrs * (ud.sueldo || 0);
                render.innerHTML += `<div class="staff-card">
                    <div class="staff-info"><b>${ud.nombre}</b><span>${ud.rol} • ${hrs.toFixed(2)} Hrs</span></div>
                    <div style="text-align:right">
                        <h2>$${total.toFixed(2)}</h2>
                        <button class="pay-btn" onclick="window.payEmployee('${u.id}', '${ud.nombre}', ${total})">PAGAR</button>
                    </div>
                </div>`;
            });
        };

        window.payEmployee = async (id, name, amount) => {
            if(amount <= 0) return window.show("SIN SALDO PENDIENTE", true);
            await addDoc(collection(db, "pagos"), { uid: id, nombre: name, monto: amount, fecha: new Date().toISOString() });
            await addDoc(collection(db, "finanzas"), { monto: amount, concepto: "PAGO NÓMINA: " + name, canal: "CAJA", tipo: "GASTO", fecha: new Date().toISOString() });
            window.show("PAGO PROCESADO");
            window.loadPayroll();
            window.loadPayments();
            window.loadFin();
        };

        window.loadPayments = async () => {
            const snap = await getDocs(query(collection(db, "pagos"), orderBy("fecha", "desc"), limit(10)));
            const box = document.getElementById('payment-history');
            box.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                box.innerHTML += `<div class="staff-card"><b>${p.nombre}</b><span>$${p.monto} - ${new Date(p.fecha).toLocaleDateString()}</span></div>`;
            });
        };

        window.addTask = async () => {
            const t = document.getElementById('ad-task').value;
            await addDoc(collection(db, "tareas"), { tarea: t });
            document.getElementById('ad-task').value = "";
            window.loadTasks();
        };

        window.loadTasks = async () => {
            const snap = await getDocs(collection(db, "tareas"));
            const box = document.getElementById('admin-tasks');
            box.innerHTML = "";
            snap.forEach(d => {
                box.innerHTML += `<div class="staff-card"><span>${d.data().tarea}</span></div>`;
            });
        };

        /* --- UTILIDADES --- */
        window.show = (m, e) => {
            const t = document.getElementById('toast');
            t.innerText = m;
            t.style.display = 'block';
            t.style.background = e ? 'var(--terracota)' : 'var(--dorado)';
            t.style.color = e ? '#fff' : '#000';
            setTimeout(() => t.style.display = 'none', 3000);
        };

        window.boot = () => {
            window.go('reloj');
            window.loadFin();
            window.drawCal();
            window.loadRecipes();
            window.loadStock();
            if(window.user.rol === 'Socio') {
                window.loadPunchHistory();
                window.loadPayroll();
                window.loadTasks();
                window.loadPayments();
            }
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString('es-MX', {hour12:false});
                document.getElementById('clock-date').innerText = now.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'long'});
            }, 1000);
        };
    </script>
</body>
</html>
