<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EscarolaOS v9.0 - Enterprise Suite</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

    <style>
        :root {
            --verde-bosque: #1b3022; --verde-oscuro: #14241a; --terracota: #b0413e;
            --cantera: #d9d4c7; --dorado: #c5a059; --negro: #0a0a0a;
            --azul-banco: #4a90e2; --blanco-trans: rgba(217, 212, 199, 0.12); 
            --shadow: 0 20px 60px rgba(0,0,0,0.9); --radius-lg: 40px; --radius-md: 25px;
        }

        /* --- BASE RESPONSIVA --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { background: var(--verde-bosque); color: var(--cantera); margin: 0; height: 100vh; overflow: hidden; }

        /* --- SISTEMA DE ACCESO --- */
        #login-screen { position: fixed; inset: 0; background: var(--verde-bosque); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 30000; transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1); }
        .grid-pin { display: grid; grid-template-columns: repeat(3, 100px); gap: 25px; }
        .btn-pin { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--dorado); background: var(--verde-oscuro); color: var(--dorado); font-size: 2.5rem; font-weight: 900; cursor: pointer; transition: 0.1s; display: flex; align-items: center; justify-content: center; }
        .btn-pin:active { background: var(--dorado); color: var(--verde-oscuro); transform: scale(0.9); }
        .dot-box { display: flex; margin-bottom: 60px; gap: 30px; }
        .dot { width: 28px; height: 28px; border: 3px solid var(--dorado); border-radius: 50%; transition: 0.4s; }
        .dot.active { background: var(--dorado); box-shadow: 0 0 35px var(--dorado); }

        /* --- CONTENEDORES ADAPTATIVOS --- */
        .container { 
            width: 100%; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
            display: none; 
            height: 100vh; 
            overflow-y: auto; 
            padding-bottom: 180px; 
            scrollbar-width: none; 
        }
        .container::-webkit-scrollbar { display: none; }

        /* --- GRID DE CAPITAL OPTIMIZADO --- */
        .main-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card { 
            background: var(--verde-oscuro); 
            border-radius: var(--radius-md); 
            padding: 30px; 
            border: 1px solid var(--blanco-trans); 
            box-shadow: var(--shadow); 
            position: relative; 
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CAJAS DE TOTALES --- */
        .stat-card {
            padding: 25px;
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.03); }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.7; font-weight: 800; }
        .stat-value { font-size: 2.2rem; font-weight: 900; margin: 10px 0; }

        /* --- INPUTS Y BOTONES --- */
        .btn-pill { 
            border-radius: 100px; 
            border: none; 
            padding: 24px; 
            font-weight: 900; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            text-transform: uppercase; 
            font-size: 1rem; 
            width: 100%; 
            transition: all 0.4s; 
            letter-spacing: 2px; 
        }
        .btn-gold { background: var(--dorado); color: var(--verde-oscuro); }
        .btn-red { background: var(--terracota); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--dorado); color: var(--dorado); }
        
        input, select, textarea { 
            width: 100%; 
            padding: 22px; 
            margin: 12px 0; 
            background: var(--negro); 
            border: 1px solid var(--blanco-trans); 
            border-radius: 20px; 
            color: white; 
            font-size: 1.1rem; 
            outline: none; 
        }

        /* --- NAVBAR RESPONSIVA --- */
        #main-nav { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 95%; 
            max-width: 900px; 
            background: rgba(10, 10, 10, 0.98); 
            border-radius: 100px; 
            border: 1px solid var(--dorado); 
            display: none; 
            grid-template-columns: repeat(5, 1fr); 
            padding: 15px 10px; 
            z-index: 25000; 
            backdrop-filter: blur(20px); 
        }
        .tab-item { text-align: center; color: var(--cantera); opacity: 0.4; cursor: pointer; transition: 0.3s; }
        .tab-item.active { opacity: 1; color: var(--dorado); transform: translateY(-10px); }
        .tab-item i { font-size: 1.8rem; display: block; margin-bottom: 5px; }
        .tab-item span { font-size: 0.65rem; font-weight: 900; text-transform: uppercase; }

        /* --- MEDIA QUERIES PARA PC/TABLET --- */
        @media (min-width: 1024px) {
            .container { padding: 50px; }
            .main-dashboard-grid { grid-template-columns: repeat(4, 1fr); }
            .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            #main-nav { width: 60%; padding: 20px; }
        }

        /* --- MODALES --- */
        .full-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 40000; align-items: center; justify-content: center; padding: 25px; backdrop-filter: blur(15px); }
        .modal-content { width: 100%; max-width: 650px; background: var(--verde-oscuro); border-radius: var(--radius-md); padding: 40px; border: 1px solid var(--dorado); }

        #toast { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); padding: 20px 60px; border-radius: 100px; font-weight: 900; display: none; z-index: 50000; box-shadow: var(--shadow); letter-spacing: 2px; text-align: center; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="login-screen">
        <h1 style="letter-spacing:15px; font-size:3.5rem; margin-bottom:10px; font-weight:900">ESCAROLA<span style="color:var(--dorado)">OS</span></h1>
        <p style="color:var(--dorado); letter-spacing:8px; font-size:0.8rem; margin-bottom:60px; font-weight:bold; opacity:0.7">SISTEMA INTEGRADO DE GESTIÓN v9.0</p>
        <div class="dot-box">
            <div id="p0" class="dot"></div><div id="p1" class="dot"></div><div id="p2" class="dot"></div><div id="p3" class="dot"></div>
        </div>
        <div class="grid-pin">
            <button class="btn-pin" onclick="window.pinWrite('1')">1</button><button class="btn-pin" onclick="window.pinWrite('2')">2</button><button class="btn-pin" onclick="window.pinWrite('3')">3</button>
            <button class="btn-pin" onclick="window.pinWrite('4')">4</button><button class="btn-pin" onclick="window.pinWrite('5')">5</button><button class="btn-pin" onclick="window.pinWrite('6')">6</button>
            <button class="btn-pin" onclick="window.pinWrite('7')">7</button><button class="btn-pin" onclick="window.pinWrite('8')">8</button><button class="btn-pin" onclick="window.pinWrite('9')">9</button>
            <button class="btn-pin" onclick="window.pinClear()" style="color:var(--terracota)">C</button><button class="btn-pin" onclick="window.pinWrite('0')">0</button><button class="btn-pin" onclick="location.reload()"><i class="fa-solid fa-sync"></i></button>
        </div>
    </div>

    <div id="finanzas" class="container">
        <div class="card" style="border-bottom: 8px solid var(--dorado); margin-bottom: 25px;">
            <label class="stat-label">Liquidez Total Neta (Efectivo + Banco)</label>
            <h1 id="f-total-neto" style="font-size:4.5rem; margin:10px 0; font-weight:900; color:#fff">$0.00</h1>
        </div>

        <div class="main-dashboard-grid">
            <div class="stat-card" style="background: rgba(197,160,89,0.1); border-left: 5px solid var(--dorado);">
                <span class="stat-label">Caja Chica</span>
                <h2 id="f-caja" class="stat-value" style="color:var(--dorado)">$0.00</h2>
            </div>
            <div class="stat-card" style="background: rgba(74,144,226,0.1); border-left: 5px solid var(--azul-banco);">
                <span class="stat-label">Cuentas Bancarias</span>
                <h2 id="f-banco" class="stat-value" style="color:var(--azul-banco)">$0.00</h2>
            </div>
            <div class="stat-card" style="background: rgba(176,65,62,0.1); border-left: 5px solid var(--terracota);">
                <span class="stat-label">Gastos del Mes</span>
                <h2 id="f-gastos" class="stat-value" style="color:var(--terracota)">$0.00</h2>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.05); border-left: 5px solid #fff;">
                <span class="stat-label">Entradas Totales</span>
                <h2 id="f-ingresos-total" class="stat-value" style="color:#fff">$0.00</h2>
            </div>
        </div>

        <div class="form-grid-2">
            <div class="card">
                <h3><i class="fa-solid fa-plus-circle"></i> Nuevo Movimiento</h3>
                <label>Descripción del concepto</label>
                <input type="text" id="fn-desc" placeholder="Ej. Venta matutina, Compra insumos...">
                <label>Importe ($)</label>
                <input type="number" id="fn-monto" step="0.01" placeholder="0.00">
                <label>Método / Ubicación del dinero</label>
                <select id="fn-metodo">
                    <option value="CAJA">Caja Física (Efectivo)</option>
                    <option value="BANCO">Banco (Digital / Terminal)</option>
                </select>
                <div style="display:flex; gap:15px; margin-top:20px">
                    <button class="btn-pill btn-gold" onclick="window.registrarFinanza('INGRESO')">INGRESO</button>
                    <button class="btn-pill btn-red" onclick="window.registrarFinanza('GASTO')">GASTO</button>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-barcode"></i> OCR Scanner IA</h3>
                <p style="opacity:0.6; font-size:0.9rem">Digitaliza tus tickets y facturas automáticamente.</p>
                <input type="file" id="ocr-input" accept="image/*" hidden onchange="window.scanIA(this)">
                <button class="btn-pill btn-outline" onclick="document.getElementById('ocr-input').click()">
                    <i class="fa-solid fa-camera"></i> ESCANEAR DOCUMENTO
                </button>
                <div id="ocr-load" style="display:none; text-align:center; margin-top:30px">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size:2.5rem; color:var(--dorado)"></i>
                    <p style="font-weight:900; color:var(--dorado); margin-top:10px">PROCESANDO IMAGEN...</p>
                </div>
            </div>
        </div>

        <div id="fn-historial" style="margin-top:30px"></div>
    </div>

    <div id="agenda" class="container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <button onclick="window.calMover(-1)" class="btn-pill btn-outline" style="width:60px; padding:10px"><i class="fa-solid fa-chevron-left"></i></button>
                <h2 id="cal-mes-txt" style="letter-spacing:5px; margin:0">ENERO 2026</h2>
                <button onclick="window.calMover(1)" class="btn-pill btn-outline" style="width:60px; padding:10px"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="cal-grid" id="cal-render"></div>
        </div>
        <div class="form-grid-2">
            <div class="card">
                <h3><i class="fa-solid fa-calendar-check"></i> Nueva Reservación</h3>
                <label>Cliente</label><input type="text" id="ag-cliente">
                <label>Fecha y Hora</label><input type="datetime-local" id="ag-hora">
                <label>Comentarios</label><textarea id="ag-notas" rows="3"></textarea>
                <button class="btn-pill btn-gold" onclick="window.guardarEvento()">CONFIRMAR AGENDA</button>
            </div>
            <div id="ag-lista-dia"></div>
        </div>
    </div>

    <div id="reloj" class="container">
        <div class="card" style="text-align:center; border: 4px solid var(--dorado);">
            <h1 id="live-h" style="font-size:7rem; margin:0; font-weight:900; letter-spacing:-3px">00:00:00</h1>
            <p id="live-d" style="font-size:1.8rem; color:var(--dorado); font-weight:bold; text-transform:uppercase"></p>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; margin-top:40px">
            <button class="btn-pill btn-gold" style="height:220px; font-size:2.5rem; flex-direction:column" onclick="window.actionReloj('ENTRADA')">
                <i class="fa-solid fa-id-badge" style="font-size:4rem"></i> ENTRADA
            </button>
            <button class="btn-pill btn-red" style="height:220px; font-size:2.5rem; flex-direction:column" onclick="window.actionReloj('SALIDA')">
                <i class="fa-solid fa-sign-out-alt" style="font-size:4rem"></i> SALIDA
            </button>
        </div>
        <div class="card" style="margin-top:40px">
            <h3><i class="fa-solid fa-history"></i> Registros Recientes</h3>
            <div id="staff-turno"></div>
        </div>
    </div>

    <div id="cocina" class="container">
        <div class="form-grid-2">
            <div class="card">
                <h3><i class="fa-solid fa-mortar-pestle"></i> Costeo de Recetas</h3>
                <label>Nombre del Platillo</label><input type="text" id="rc-nombre">
                <div id="rc-ingredientes-area"></div>
                <button class="btn-pill btn-outline" style="margin:20px 0" onclick="window.addIngredienteUI()">+ AGREGAR INSUMO</button>
                <div class="stat-card" style="background:#000; border: 1px solid var(--dorado)">
                    <span class="stat-label">Costo total de producción:</span>
                    <h2 id="rc-costo-total" style="font-size:3rem; margin:10px 0">$0.00</h2>
                </div>
                <button class="btn-pill btn-gold" style="margin-top:20px" onclick="window.guardarReceta()">GUARDAR EN RECETARIO</button>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-boxes-stacked"></i> Inventario e Insumos</h3>
                <input type="file" id="xl-input" accept=".xlsx, .xls" hidden onchange="window.importXL(this)">
                <button class="btn-pill btn-outline" onclick="document.getElementById('xl-input').click()">IMPORTAR EXCEL (.XLSX)</button>
                <div id="recetas-render" style="margin-top:20px"></div>
            </div>
        </div>
    </div>

    <div id="admin" class="container">
        <div class="main-dashboard-grid">
            <div class="card">
                <h3>Nómina Pendiente</h3>
                <div id="adm-nomina-view"></div>
            </div>
            <div class="card">
                <h3>Control de Usuarios</h3>
                <label>Nombre</label><input type="text" id="u-nombre">
                <label>PIN Acceso</label><input type="number" id="u-pin">
                <label>Sueldo/Hora</label><input type="number" id="u-sueldo">
                <label>Rol</label>
                <select id="u-rol"><option value="Staff">Staff</option><option value="Socio">Socio</option></select>
                <button class="btn-pill btn-gold" onclick="window.crearUsuario()">AÑADIR PERSONAL</button>
                <div id="adm-users-list" style="margin-top:20px"></div>
            </div>
            <div class="card">
                <h3>Tareas de Limpieza</h3>
                <div id="adm-checklist-view"></div>
                <div style="display:flex; gap:10px; margin-top:15px">
                    <input type="text" id="task-new" placeholder="Nueva tarea...">
                    <button class="btn-pill btn-gold" style="width:80px" onclick="window.crearTarea()">+</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-edit-fin" class="full-modal">
        <div class="modal-content">
            <h2 style="color:var(--dorado)"><i class="fa-solid fa-pen-to-square"></i> Editar Movimiento</h2>
            <input type="hidden" id="edit-fn-id">
            <label>Concepto</label><input type="text" id="edit-fn-desc">
            <label>Importe</label><input type="number" id="edit-fn-monto" step="0.01">
            <label>Canal</label>
            <select id="edit-fn-metodo"><option value="CAJA">Caja</option><option value="BANCO">Banco</option></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
                <button class="btn-pill btn-gold" onclick="window.updateFinanza()">ACTUALIZAR</button>
                <button class="btn-pill btn-outline" onclick="window.closeModals()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-edit-user" class="full-modal">
        <div class="modal-content">
            <h2 style="color:var(--dorado)">Perfil del Colaborador</h2>
            <input type="hidden" id="edit-u-id">
            <label>Nombre</label><input type="text" id="edit-u-nom">
            <label>PIN</label><input type="number" id="edit-u-pin-val">
            <label>Sueldo</label><input type="number" id="edit-u-sueldo-val">
            <label>Rol</label>
            <select id="edit-u-rol-val"><option value="Staff">Staff</option><option value="Socio">Socio</option></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
                <button class="btn-pill btn-gold" onclick="window.updateUsuario()">GUARDAR</button>
                <button class="btn-pill btn-outline" onclick="window.closeModals()">SALIR</button>
            </div>
        </div>
    </div>

    <div id="modal-c" class="full-modal">
        <div class="modal-content" style="text-align:center">
            <h2 style="color:var(--dorado); letter-spacing:5px">PROTOCOLO DE CIERRE</h2>
            <div id="modal-tasks-list" style="margin:30px 0; text-align:left"></div>
            <button class="btn-pill btn-gold" style="height:100px; font-size:1.8rem" onclick="window.finalizarSalida()">CONFIRMAR SALIDA</button>
        </div>
    </div>

    <nav id="main-nav">
        <div class="tab-item" id="tab-finanzas" onclick="window.nav('finanzas')"><i class="fa-solid fa-sack-dollar"></i><span>Capital</span></div>
        <div class="tab-item" id="tab-agenda" onclick="window.nav('agenda')"><i class="fa-solid fa-calendar-alt"></i><span>Agenda</span></div>
        <div class="tab-item" id="tab-reloj" onclick="window.nav('reloj')"><i class="fa-solid fa-clock"></i><span>Reloj</span></div>
        <div class="tab-item" id="tab-cocina" onclick="window.nav('cocina')"><i class="fa-solid fa-utensils"></i><span>Cocina</span></div>
        <div class="tab-item" id="tab-admin" onclick="window.nav('admin')"><i class="fa-solid fa-user-shield"></i><span>Admin</span></div>
    </nav>

    <script type="module">
        import { db, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, orderBy, limit } from './firebase-config.js';

        // --- GLOBAL STATE ---
        window.pinIn = ""; window.me = null; window.curCal = new Date();

        // --- SISTEMA DE PIN ---
        window.pinWrite = (n) => {
            if(window.pinIn.length < 4) {
                window.pinIn += n; window.upDots();
                if(window.pinIn.length === 4) window.login();
            }
        };
        window.pinClear = () => { window.pinIn = ""; window.upDots(); };
        window.upDots = () => {
            for(let i=0; i<4; i++) document.getElementById(`p${i}`).classList.toggle('active', i < window.pinIn.length);
        };

        window.login = async () => {
            const q = query(collection(db, "usuarios"), where("pin", "==", window.pinIn));
            const snap = await getDocs(q);
            if(!snap.empty) {
                window.me = { id: snap.docs[0].id, ...snap.docs[0].data() };
                document.getElementById('login-screen').style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-nav').style.display = 'grid';
                    window.initApp();
                }, 800);
            } else { window.toast("PIN INVÁLIDO", true); window.pinClear(); }
        };

        // --- NAVEGACIÓN ---
        window.nav = (id) => {
            if((id === 'finanzas' || id === 'admin') && window.me.rol !== 'Socio') return window.toast("ACCESO RESTRINGIDO", true);
            document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            document.getElementById(`tab-${id}`).classList.add('active');
        };

        // --- CAPITAL (LÓGICA CORREGIDA) ---
        window.registrarFinanza = async (tipo) => {
            const m = parseFloat(document.getElementById('fn-monto').value);
            const d = document.getElementById('fn-desc').value;
            const mt = document.getElementById('fn-metodo').value;
            if(!m || !d) return window.toast("FALTAN DATOS", true);
            
            await addDoc(collection(db, "finanzas"), {
                monto: m, desc: d, metodo: mt, tipo, fecha: new Date().toISOString()
            });
            
            document.getElementById('fn-monto').value = "";
            document.getElementById('fn-desc').value = "";
            window.toast("REGISTRO EXITOSO");
            await window.loadFinanzas(); // Recarga inmediata para mover los cuadros
        };

        window.loadFinanzas = async () => {
            const snap = await getDocs(query(collection(db, "finanzas"), orderBy("fecha", "desc")));
            let totalCaja = 0, totalBanco = 0, totalGastos = 0, totalIngresos = 0;
            const h = document.getElementById('fn-historial'); 
            h.innerHTML = "<h3>Historial de Movimientos</h3>";
            
            snap.forEach(d => {
                const f = d.data();
                const monto = parseFloat(f.monto);
                
                if(f.tipo === 'INGRESO') {
                    totalIngresos += monto;
                    if(f.metodo === 'CAJA') totalCaja += monto; else totalBanco += monto;
                } else {
                    totalGastos += monto;
                    if(f.metodo === 'CAJA') totalCaja -= monto; else totalBanco -= monto;
                }

                h.innerHTML += `<div class="card" style="padding:15px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid ${f.tipo==='INGRESO'?'var(--dorado)':'var(--terracota)'}">
                    <div><b>${f.desc}</b><br><small>${f.metodo} • ${f.fecha.split('T')[0]}</small></div>
                    <div style="text-align:right">
                        <b style="color:${f.tipo==='GASTO'?'var(--terracota)':'var(--dorado)'}">${f.tipo==='GASTO'?'-':'+'}$${monto.toFixed(2)}</b><br>
                        <button class="btn-action btn-edit" onclick="window.openEditFin('${d.id}','${f.desc}',${monto},'${f.metodo}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-action btn-del" onclick="window.delDoc('finanzas','${d.id}','loadFinanzas')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`;
            });

            // Actualización de UI en tiempo real
            document.getElementById('f-caja').innerText = `$${totalCaja.toFixed(2)}`;
            document.getElementById('f-banco').innerText = `$${totalBanco.toFixed(2)}`;
            document.getElementById('f-gastos').innerText = `$${totalGastos.toFixed(2)}`;
            document.getElementById('f-ingresos-total').innerText = `$${totalIngresos.toFixed(2)}`;
            document.getElementById('f-total-neto').innerText = `$${(totalCaja + totalBanco).toFixed(2)}`;
        };

        window.openEditFin = (id, d, m, mt) => {
            document.getElementById('edit-fn-id').value = id;
            document.getElementById('edit-fn-desc').value = d;
            document.getElementById('edit-fn-monto').value = m;
            document.getElementById('edit-fn-metodo').value = mt;
            document.getElementById('modal-edit-fin').style.display = 'flex';
        };

        window.updateFinanza = async () => {
            await updateDoc(doc(db, "finanzas", document.getElementById('edit-fn-id').value), {
                desc: document.getElementById('edit-fn-desc').value,
                monto: parseFloat(document.getElementById('edit-fn-monto').value),
                metodo: document.getElementById('edit-fn-metodo').value
            });
            window.closeModals(); window.loadFinanzas(); window.toast("REGISTRO ACTUALIZADO");
        };

        // --- RELOJ Y ASISTENCIAS ---
        window.actionReloj = async (tipo) => {
            if(tipo === 'SALIDA') {
                const snap = await getDocs(collection(db, "checklist"));
                let h = ""; snap.forEach(d => h += `<div style="padding:15px; border-bottom:1px solid #333; display:flex; align-items:center; gap:20px"><input type="checkbox" style="width:30px; height:30px" class="t-chk"> <span style="font-weight:bold">${d.data().tarea}</span></div>`);
                document.getElementById('modal-tasks-list').innerHTML = h || "<p>No hay tareas pendientes.</p>";
                document.getElementById('modal-c').style.display = 'flex';
            } else { await window.saveAsistencia('ENTRADA'); }
        };

        window.finalizarSalida = async () => {
            const checks = document.querySelectorAll('.t-chk');
            if(checks.length > 0 && !Array.from(checks).every(c => c.checked)) return window.toast("DEBE COMPLETAR LIMPIEZA", true);
            document.getElementById('modal-c').style.display = 'none';
            await window.saveAsistencia('SALIDA');
        };

        window.saveAsistencia = async (tipo) => {
            await addDoc(collection(db, "asistencias"), {
                uid: window.me.id, nombre: window.me.nombre, tipo, sueldo: window.me.sueldo,
                time: new Date().toISOString(), pagado: false
            });
            window.toast("REGISTRO DE " + tipo); window.loadStaffActivo();
        };

        window.loadStaffActivo = async () => {
            const snap = await getDocs(query(collection(db, "asistencias"), orderBy("time", "desc"), limit(12)));
            const div = document.getElementById('staff-turno'); div.innerHTML = "";
            snap.forEach(d => {
                const a = d.data();
                div.innerHTML += `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #222; align-items:center">
                    <span style="font-weight:bold">${a.nombre}</span> 
                    <div><b style="color:var(--dorado)">${a.tipo}</b> <small style="opacity:0.5; margin-left:10px">${new Date(a.time).toLocaleTimeString()}</small></div>
                </div>`;
            });
        };

        // --- AGENDA ---
        window.guardarEvento = async () => {
            const c = document.getElementById('ag-cliente').value;
            const f = document.getElementById('ag-hora').value;
            if(!c || !f) return window.toast("DATOS INCOMPLETOS", true);
            await addDoc(collection(db, "agenda"), { cliente: c, fecha: f, notas: document.getElementById('ag-notas').value });
            window.toast("RESERVA AGENDADA"); window.renderCal();
            document.getElementById('ag-cliente').value = ""; document.getElementById('ag-notas').value = "";
        };

        window.renderCal = async () => {
            const g = document.getElementById('cal-render'); g.innerHTML = "";
            const m = window.curCal.getMonth(); const a = window.curCal.getFullYear();
            document.getElementById('cal-mes-txt').innerText = window.curCal.toLocaleDateString('es-MX', {month:'long', year:'numeric'}).toUpperCase();
            const snap = await getDocs(collection(db, "agenda"));
            let evs = []; snap.forEach(d => evs.push(d.data().fecha.split('T')[0]));
            for(let i=0; i<new Date(a, m, 1).getDay(); i++) g.innerHTML += `<div></div>`;
            for(let d=1; d<=new Date(a, m+1, 0).getDate(); d++) {
                const ds = `${a}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const has = evs.includes(ds);
                g.innerHTML += `<div class="cal-day ${has?'has-ev':''}" onclick="window.verDia('${ds}')">${d}${has?'<div class="cal-dot"></div>':''}</div>`;
            }
        };

        window.verDia = async (f) => {
            const snap = await getDocs(query(collection(db, "agenda"), where("fecha", ">=", f), where("fecha", "<=", f+"T23:59")));
            const div = document.getElementById('ag-lista-dia'); div.innerHTML = `<h3>Eventos: ${f}</h3>`;
            if(snap.empty) div.innerHTML += "<p>Sin reservaciones.</p>";
            snap.forEach(d => {
                const ev = d.data();
                div.innerHTML += `<div class="card" style="margin-bottom:10px">
                    <b>${ev.cliente}</b> - ${ev.fecha.split('T')[1]}h<br><small>${ev.notas || ''}</small>
                    <div style="text-align:right"><button class="btn-action btn-del" onclick="window.delDoc('agenda','${d.id}','renderCal')"><i class="fa-solid fa-trash"></i></button></div>
                </div>`;
            });
        };

        // --- ADMINISTRACIÓN ---
        window.crearUsuario = async () => {
            const n = document.getElementById('u-nombre').value;
            const p = document.getElementById('u-pin').value;
            const s = document.getElementById('u-sueldo').value;
            const r = document.getElementById('u-rol').value;
            if(!n || !p || !s) return window.toast("DATOS REQUERIDOS", true);
            await addDoc(collection(db, "usuarios"), { nombre: n, pin: p, sueldo: parseFloat(s), rol: r });
            window.loadUsers(); window.toast("USUARIO CREADO");
        };

        window.loadUsers = async () => {
            const snap = await getDocs(collection(db, "usuarios"));
            const div = document.getElementById('adm-users-list'); div.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                div.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; margin-bottom:10px; padding:15px">
                    <span><b>${u.nombre}</b><br><small>${u.rol} • $${u.sueldo}/h</small></span>
                    <button class="btn-action btn-edit" onclick="window.openEditUser('${d.id}','${u.nombre}',${u.sueldo},'${u.rol}','${u.pin}')"><i class="fa-solid fa-user-gear"></i></button>
                </div>`;
            });
        };

        window.openEditUser = (id, n, s, r, p) => {
            document.getElementById('edit-u-id').value = id;
            document.getElementById('edit-u-nom').value = n;
            document.getElementById('edit-u-sueldo-val').value = s;
            document.getElementById('edit-u-rol-val').value = r;
            document.getElementById('edit-u-pin-val').value = p;
            document.getElementById('modal-edit-user').style.display = 'flex';
        };

        window.updateUsuario = async () => {
            await updateDoc(doc(db, "usuarios", document.getElementById('edit-u-id').value), {
                nombre: document.getElementById('edit-u-nom').value,
                sueldo: parseFloat(document.getElementById('edit-u-sueldo-val').value),
                rol: document.getElementById('edit-u-rol-val').value,
                pin: document.getElementById('edit-u-pin-val').value
            });
            window.closeModals(); window.loadUsers();
        };

        window.crearTarea = async () => { 
            const t = document.getElementById('task-new').value;
            if(!t) return;
            await addDoc(collection(db, "checklist"), { tarea: t }); 
            document.getElementById('task-new').value = "";
            window.loadTasks(); 
        };

        window.loadTasks = async () => {
            const snap = await getDocs(collection(db, "checklist"));
            const div = document.getElementById('adm-checklist-view'); div.innerHTML = "";
            snap.forEach(d => div.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333"><span>${d.data().tarea}</span><button class="btn-del" onclick="window.delDoc('checklist','${d.id}','loadTasks')">✕</button></div>`);
        };

        // --- UTILIDADES ---
        window.toast = (m, e=false) => {
            const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block';
            t.style.background = e ? 'var(--terracota)' : 'var(--dorado)';
            t.style.color = e ? '#fff' : 'var(--verde-oscuro)';
            setTimeout(() => t.style.display='none', 3000);
        };
        window.delDoc = async (c, id, cb) => { if(confirm("¿CONFIRMAR ELIMINACIÓN?")) { await deleteDoc(doc(db, c, id)); if(window[cb]) window[cb](); } };
        window.closeModals = () => { document.querySelectorAll('.full-modal').forEach(m => m.style.display = 'none'); };
        window.calMover = (n) => { window.curCal.setMonth(window.curCal.getMonth() + n); window.renderCal(); };
        window.addIngredienteUI = () => {
            const d = document.createElement('div'); d.className = 'form-grid-2';
            d.innerHTML = `<input type="text" class="r-i-n" placeholder="Insumo"><input type="number" class="r-i-c" oninput="window.calcR()" placeholder="Costo">`;
            document.getElementById('rc-ingredientes-area').appendChild(d);
        };
        window.calcR = () => {
            let t = 0; document.querySelectorAll('.r-i-c').forEach(i => t += parseFloat(i.value || 0));
            document.getElementById('rc-costo-total').innerText = `$${t.toFixed(2)}`;
        };
        window.guardarReceta = async () => {
            const ings = []; document.querySelectorAll('.r-i-n').forEach((el, i) => ings.push({ n: el.value, c: document.querySelectorAll('.r-i-c')[i].value }));
            await addDoc(collection(db, "recetas"), { nombre: document.getElementById('rc-nombre').value, ingredientes: ings, total: document.getElementById('rc-costo-total').innerText });
            window.toast("RECETA GUARDADA");
        };

        window.scanIA = async (i) => {
            document.getElementById('ocr-load').style.display='block';
            try {
                const { data: { text } } = await Tesseract.recognize(i.files[0], 'spa');
                const m = text.match(/(\d+[\.,]\d{2})/);
                if(m) { document.getElementById('fn-monto').value = m[0].replace(',','.'); window.toast("VALOR DETECTADO"); }
            } catch (e) { window.toast("ERROR SCAN", true); }
            document.getElementById('ocr-load').style.display='none';
        };

        window.initApp = () => {
            window.nav(window.me.rol === 'Socio' ? 'finanzas' : 'reloj');
            window.loadStaffActivo(); window.renderCal();
            if(window.me.rol === 'Socio') { window.loadFinanzas(); window.loadUsers(); window.loadTasks(); }
            setInterval(() => {
                const n = new Date();
                document.getElementById('live-h').innerText = n.toLocaleTimeString('es-MX', {hour12:false});
                document.getElementById('live-d').innerText = n.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'long'});
            }, 1000);
        };
    </script>
</body>
</html>
