<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EscarolaOS v13.2 - Enterprise Gastronomic Engine</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ESCAROLA OS - ARQUITECTURA VISUAL 2026
           Diseño de alta densidad para entornos de alto tráfico.
        */
        :root {
            --verde-bosque: #1b3022;
            --verde-oscuro: #14241a;
            --terracota: #b0413e;
            --cantera: #d9d4c7;
            --dorado: #c5a059;
            --negro: #0a0a0a;
            --azul-banco: #4a90e2;
            --blanco-trans: rgba(217, 212, 199, 0.12); 
            --glass: rgba(255, 255, 255, 0.03);
            --shadow-extreme: 0 35px 70px -15px rgba(0, 0, 0, 0.95);
            --radius-max: 50px;
            --radius-mid: 25px;
            --transition-speed: 0.3s;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* RESET Y NORMALIZACIÓN */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0;
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
        }

        body { 
            background: var(--verde-bosque); 
            color: var(--cantera); 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* SISTEMA DE SEGURIDAD: PINPAD AUTH
        */
        #login-screen { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at center, #1b3022, #050505); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 999999; 
            transition: opacity 0.6s ease;
        }

        .login-branding { 
            text-align: center; 
            margin-bottom: 60px; 
            animation: fadeInDown 0.8s ease;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-branding h1 { 
            letter-spacing: 18px; 
            font-size: 3.8rem; 
            font-weight: 900; 
            color: #fff;
            text-shadow: 0 15px 35px rgba(0,0,0,0.7);
        }
        .login-branding h1 span { color: var(--dorado); }
        .login-branding p { 
            color: var(--dorado); 
            letter-spacing: 7px; 
            font-size: 0.8rem; 
            font-weight: 800; 
            opacity: 0.7; 
            margin-top: 15px;
            text-transform: uppercase;
        }

        .pin-container { 
            display: flex; 
            gap: 30px; 
            margin-bottom: 60px; 
        }
        .pin-slot { 
            width: 25px; 
            height: 25px; 
            border: 3px solid var(--dorado); 
            border-radius: 50%; 
            transition: all 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
        }
        .pin-slot.active { 
            background: var(--dorado); 
            box-shadow: 0 0 30px var(--dorado); 
            transform: scale(1.4); 
        }

        .pin-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 25px; 
            width: 100%; 
            max-width: 360px; 
        }

        .pin-key { 
            aspect-ratio: 1; 
            border-radius: 50%; 
            border: 2px solid var(--blanco-trans); 
            background: var(--glass); 
            color: var(--dorado); 
            font-size: 2.2rem; 
            font-weight: 300; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: transform 0.1s, background 0.1s;
            user-select: none;
        }

        .pin-key:active { 
            background: var(--dorado); 
            color: var(--verde-oscuro); 
            transform: scale(0.9); 
            border-color: var(--dorado);
        }

        /* VISTAS PRINCIPALES Y LAYOUT
        */
        .app-container {
            position: relative;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        .view-content { 
            width: 100%; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 30px; 
            display: none; 
            height: 100vh; 
            overflow-y: auto; 
            padding-bottom: 200px; 
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .view-content::-webkit-scrollbar { display: none; }

        .module-card { 
            background: var(--verde-oscuro); 
            border-radius: var(--radius-max); 
            padding: 40px; 
            margin-bottom: 35px; 
            border: 1px solid var(--blanco-trans); 
            box-shadow: var(--shadow-extreme); 
            transition: transform 0.3s ease;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 35px;
            border-left: 5px solid var(--dorado);
            padding-left: 20px;
        }

        .section-header h2 {
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--dorado);
            font-weight: 900;
        }

        /* MÓDULO FINANCIERO: CAPITAL
        */
        .capital-hero {
            text-align: center;
            padding: 70px 30px;
            margin-bottom: 40px;
            background: linear-gradient(145deg, #14241a 0%, #050505 100%);
            border-radius: var(--radius-max);
            border: 2px solid var(--blanco-trans);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .capital-hero .label {
            font-size: 0.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 5px;
            color: var(--dorado);
            opacity: 0.6;
        }

        .capital-hero .total-amount {
            font-size: 5.5rem;
            font-weight: 900;
            color: #fff;
            letter-spacing: -5px;
            margin: 20px 0;
            text-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        @media (min-width: 1024px) {
            .kpi-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .kpi-card {
            background: var(--glass);
            padding: 35px 20px;
            border-radius: 35px;
            border: 1px solid var(--blanco-trans);
            text-align: center;
            transition: 0.3s;
        }
        .kpi-card:hover { transform: translateY(-10px); background: rgba(255,255,255,0.06); }
        .kpi-card h4 { font-size: 2rem; color: #fff; margin-top: 10px; font-weight: 800; }
        .kpi-card span { font-size: 0.7rem; font-weight: 900; opacity: 0.5; text-transform: uppercase; }

        /* MÓDULO CALENDARIO: AGENDA 2026
        */
        .calendar-box {
            background: #0b130e;
            border-radius: 40px;
            padding: 35px;
            border: 1px solid var(--blanco-trans);
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .current-month {
            font-size: 1.4rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 6px;
            color: var(--dorado);
        }

        .grid-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
        }

        .day-label {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 900;
            color: var(--dorado);
            padding-bottom: 20px;
            opacity: 0.5;
        }

        .day-square {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.03);
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
            position: relative;
        }
        .day-square.active-day { border-color: var(--dorado); background: rgba(197,160,89,0.1); color: var(--dorado); font-weight: 900; }
        .day-square.has-data::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--dorado);
            border-radius: 50%;
            position: absolute;
            bottom: 12px;
            box-shadow: 0 0 10px var(--dorado);
        }
        .day-square.blur-day { opacity: 0.15; pointer-events: none; }
        .day-square:active { transform: scale(0.85); }

        /* MÓDULO RELOJ: ASISTENCIA STAFF
        */
        .reloj-hero {
            text-align: center;
            padding: 80px 20px;
            background: radial-gradient(circle at top, #1a2e21, #000);
            border-radius: 60px;
            border: 3px solid var(--dorado);
            margin-bottom: 50px;
            box-shadow: 0 0 60px rgba(0,0,0,0.7);
        }

        #digital-clock { 
            font-size: 24vw; 
            font-weight: 900; 
            color: #fff; 
            line-height: 0.8; 
            text-shadow: 0 20px 40px rgba(0,0,0,0.9); 
        }
        @media (min-width: 1024px) { #digital-clock { font-size: 10rem; } }
        
        #digital-date { 
            color: var(--dorado); 
            font-weight: 800; 
            letter-spacing: 8px; 
            text-transform: uppercase; 
            margin-top: 30px; 
            font-size: 1.2rem; 
        }

        .punch-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 30px; 
        }

        .btn-action-punch {
            height: 210px;
            border-radius: 50px;
            border: none;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 25px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.1rem;
        }
        .btn-action-punch i { font-size: 4rem; }
        .btn-in { background: var(--dorado); color: var(--verde-oscuro); box-shadow: 0 20px 40px rgba(197,160,89,0.2); }
        .btn-out { background: var(--terracota); color: #fff; box-shadow: 0 20px 40px rgba(176,65,62,0.2); }
        .btn-action-punch:active { transform: scale(0.92); filter: brightness(1.2); }

        /* COMPONENTES DE FORMULARIO
        */
        .field-group { margin-bottom: 30px; }
        .field-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 900;
            color: var(--dorado);
            text-transform: uppercase;
            margin: 0 0 12px 20px;
            letter-spacing: 2px;
        }
        .field-group input, .field-group select, .field-group textarea {
            width: 100%;
            padding: 26px;
            border-radius: 25px;
            background: #000;
            border: 1px solid var(--blanco-trans);
            color: #fff;
            font-size: 1.15rem;
            transition: 0.3s;
        }
        .field-group input:focus { border-color: var(--dorado); outline: none; box-shadow: 0 0 25px rgba(197,160,89,0.15); }

        .btn-submit {
            width: 100%;
            padding: 28px;
            border-radius: 70px;
            border: none;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            font-size: 1.1rem;
            transition: 0.3s;
        }
        .btn-gold { background: var(--dorado); color: var(--verde-oscuro); }
        .btn-outline { background: transparent; border: 2.5px solid var(--dorado); color: var(--dorado); }

        /* SISTEMA DE NAVEGACIÓN INFERIOR (IOS READY)
        */
        #tab-bar { 
            position: fixed; 
            bottom: 40px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 95%; 
            max-width: 700px; 
            background: rgba(10, 10, 10, 0.98); 
            border-radius: 70px; 
            border: 2px solid var(--dorado); 
            display: none; 
            grid-template-columns: repeat(5, 1fr); 
            padding: 25px 15px; 
            z-index: 99999; 
            backdrop-filter: blur(40px); 
            box-shadow: 0 40px 100px rgba(0,0,0,1);
            padding-bottom: calc(25px + var(--safe-bottom));
        }

        .tab-item { 
            text-align: center; 
            color: var(--cantera); 
            opacity: 0.3; 
            cursor: pointer; 
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .tab-item.active { opacity: 1; color: var(--dorado); transform: translateY(-15px); }
        .tab-item i { font-size: 2rem; display: block; margin-bottom: 10px; }
        .tab-item span { font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }

        /* LISTADOS Y REGISTROS DINÁMICOS
        */
        .record-row { 
            background: rgba(255,255,255,0.04); 
            padding: 30px; 
            border-radius: 30px; 
            margin-bottom: 18px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 8px solid transparent; 
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .record-info b { font-size: 1.3rem; color: #fff; display: block; margin-bottom: 6px; }
        .record-info small { opacity: 0.5; font-size: 0.85rem; text-transform: uppercase; font-weight: 800; }

        .btn-delete { 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            border: none; 
            background: rgba(176,65,62,0.2); 
            color: var(--terracota); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: 0.3s;
            font-size: 1.2rem;
        }
        .btn-delete:active { transform: scale(0.8); background: var(--terracota); color: #fff; }

        /* MODALES Y NOTIFICACIONES
        */
        #toast-manager { 
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%); 
            padding: 25px 60px; border-radius: 70px; font-weight: 900; display: none; 
            z-index: 9999999; text-align: center; font-size: 1rem; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.8); border: 2px solid rgba(255,255,255,0.1);
        }

        .modal-view { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); 
            z-index: 1000000; align-items: center; justify-content: center; padding: 30px; 
        }
        .modal-wrapper { 
            width: 100%; max-width: 600px; background: var(--verde-oscuro); 
            border-radius: 60px; padding: 60px; border: 3px solid var(--dorado); 
            box-shadow: 0 0 100px rgba(0,0,0,1);
        }

        /* ESTADOS CRÍTICOS */
        .critical-pulse { border-left-color: var(--terracota) !important; background: rgba(176,65,62,0.12) !important; }
    </style>
</head>
<body>

    <div id="toast-manager"></div>

    <div id="login-screen">
        <div class="login-branding">
            <h1>ESCAROLA<span>OS</span></h1>
            <p>SISTEMA CENTRAL DE OPERACIONES</p>
        </div>
        <div class="pin-container">
            <div id="slot-1" class="pin-slot"></div>
            <div id="slot-2" class="pin-slot"></div>
            <div id="slot-3" class="pin-slot"></div>
            <div id="slot-4" class="pin-slot"></div>
        </div>
        <div class="pin-grid">
            <div class="pin-key" onclick="window.typePin('1')">1</div>
            <div class="pin-key" onclick="window.typePin('2')">2</div>
            <div class="pin-key" onclick="window.typePin('3')">3</div>
            <div class="pin-key" onclick="window.typePin('4')">4</div>
            <div class="pin-key" onclick="window.typePin('5')">5</div>
            <div class="pin-key" onclick="window.typePin('6')">6</div>
            <div class="pin-key" onclick="window.typePin('7')">7</div>
            <div class="pin-key" onclick="window.typePin('8')">8</div>
            <div class="pin-key" onclick="window.typePin('9')">9</div>
            <div class="pin-key" onclick="window.erasePin()" style="color:var(--terracota)">C</div>
            <div class="pin-key" onclick="window.typePin('0')">0</div>
            <div class="pin-key" onclick="location.reload()"><i class="fa-solid fa-rotate"></i></div>
        </div>
    </div>

    <div class="app-container">
        <div id="view-finanzas" class="view-content">
            <div class="capital-hero">
                <span class="label">Balance Consolidado</span>
                <h1 id="net-wealth" class="total-amount">$0.00</h1>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <span>Efectivo Caja</span>
                    <h4 id="stat-caja">$0.00</h4>
                </div>
                <div class="kpi-card">
                    <span>Banco / Terminal</span>
                    <h4 id="stat-banco">$0.00</h4>
                </div>
                <div class="kpi-card">
                    <span>Gasto Mensual</span>
                    <h4 id="stat-gasto" style="color:var(--terracota)">$0.00</h4>
                </div>
                <div class="kpi-card">
                    <span>Venta Bruta</span>
                    <h4 id="stat-venta" style="color:var(--dorado)">$0.00</h4>
                </div>
            </div>
            <div class="module-card">
                <div class="section-header"><h2>Registrar Movimiento</h2><i class="fa-solid fa-money-bill-transfer fa-2x"></i></div>
                <div class="field-group">
                    <label>Concepto del Movimiento</label>
                    <input type="text" id="fin-concept" placeholder="Ej: Pago Proveedor Carne">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px">
                    <div class="field-group">
                        <label>Monto Total ($)</label>
                        <input type="number" id="fin-val" step="0.01">
                    </div>
                    <div class="field-group">
                        <label>Cuenta de Origen/Destino</label>
                        <select id="fin-acc">
                            <option value="CAJA">Caja Efectivo</option>
                            <option value="BANCO">Banco / Digital</option>
                        </select>
                    </div>
                </div>
                <div class="field-group">
                    <label>Vincular a Receta (Descarga Stock)</label>
                    <select id="fin-recipe-link"><option value="">-- Sin receta vinculada --</option></select>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; margin-top:20px">
                    <button class="btn-submit btn-gold" onclick="window.pushMoney('INGRESO')">REGISTRAR INGRESO</button>
                    <button class="btn-submit" style="background:var(--terracota); color:white" onclick="window.pushMoney('GASTO')">REGISTRAR GASTO</button>
                </div>
            </div>
            <div id="finance-log-render"></div>
        </div>

        <div id="view-agenda" class="view-content">
            <div class="calendar-box">
                <div class="calendar-controls">
                    <button onclick="window.changeMo(-1)" class="btn-delete" style="background:var(--glass); color:#fff"><i class="fa-solid fa-chevron-left"></i></button>
                    <h3 id="calendar-title" class="current-month">MARZO 2026</h3>
                    <button onclick="window.changeMo(1)" class="btn-delete" style="background:var(--glass); color:#fff"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="grid-calendar" id="calendar-body"></div>
            </div>
            <div class="module-card" style="margin-top:40px">
                <div class="section-header"><h2>Nueva Reservación</h2><i class="fa-solid fa-calendar-check fa-2x"></i></div>
                <div class="field-group"><label>Cliente / Empresa</label><input type="text" id="age-customer"></div>
                <div class="field-group"><label>Fecha y Hora del Evento</label><input type="datetime-local" id="age-time"></div>
                <div class="field-group"><label>Requerimientos Especiales</label><textarea id="age-memo" rows="2"></textarea></div>
                <button class="btn-submit btn-gold" onclick="window.pushAgenda()">CONFIRMAR AGENDA</button>
            </div>
            <div id="agenda-day-render"></div>
        </div>

        <div id="view-reloj" class="view-content">
            <div class="reloj-hero">
                <h1 id="digital-clock">00:00:00</h1>
                <p id="digital-date">CARGANDO SISTEMA...</p>
            </div>
            <div class="punch-grid">
                <button class="btn-action-punch btn-in" onclick="window.handlePunch('ENTRADA')">
                    <i class="fa-solid fa-id-badge"></i>
                    <span>ENTRADA</span>
                </button>
                <button class="btn-action-punch btn-out" onclick="window.handlePunch('SALIDA')">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>SALIDA</span>
                </button>
            </div>
            <div id="punch-log-render" style="margin-top:50px"></div>
        </div>

        <div id="view-insumos" class="view-content">
            <div class="module-card">
                <div class="section-header"><h2>Inventario de Insumos</h2><i class="fa-solid fa-box-open fa-2x"></i></div>
                <div class="field-group"><label>Nombre del Producto</label><input type="text" id="ins-title"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px">
                    <div class="field-group"><label>Cantidad</label><input type="number" id="ins-quantity"></div>
                    <div class="field-group"><label>Medida</label><input type="text" id="ins-unit" placeholder="Kg/L/Pz"></div>
                    <div class="field-group"><label>Stock Crítico</label><input type="number" id="ins-alert"></div>
                </div>
                <button class="btn-submit btn-gold" onclick="window.pushStock()">ACTUALIZAR INVENTARIO</button>
            </div>
            <div id="stock-log-render"></div>

            <div class="module-card" style="margin-top:40px">
                <div class="section-header"><h2>Gestión de Recetas</h2><i class="fa-solid fa-scroll fa-2x"></i></div>
                <div class="field-group"><label>Nombre del Platillo</label><input type="text" id="rec-title"></div>
                <div id="rec-ing-container"></div>
                <button class="btn-submit btn-outline" style="margin:20px 0" onclick="window.appendIngRow()">+ AÑADIR INSUMO A RECETA</button>
                <button class="btn-submit btn-gold" onclick="window.pushRecipe()">REGISTRAR RECETA MAESTRA</button>
            </div>
            <div id="recipe-log-render"></div>
        </div>

        <div id="view-admin" class="view-content">
            <div class="module-card">
                <div class="section-header"><h2>Control de Acceso Staff</h2><i class="fa-solid fa-users-gear fa-2x"></i></div>
                <div class="field-group"><label>Nombre Completo</label><input type="text" id="adm-name"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px">
                    <div class="field-group"><label>PIN Acceso (4 Dígitos)</label><input type="number" id="adm-pin"></div>
                    <div class="field-group"><label>Sueldo por Hora</label><input type="number" id="adm-wage"></div>
                </div>
                <div class="field-group">
                    <label>Rango de Autorización</label>
                    <select id="adm-role"><option value="Staff">Equipo Staff</option><option value="Socio">Socio / Gerente</option></select>
                </div>
                <button class="btn-submit btn-gold" onclick="window.pushUser()">DAR DE ALTA COLABORADOR</button>
            </div>
            <div id="user-log-render"></div>

            <div class="module-card">
                <div class="section-header"><h2>Checklist de Limpieza</h2><i class="fa-solid fa-broom fa-2x"></i></div>
                <div id="task-log-render"></div>
                <div style="display:flex; gap:20px; margin-top:30px">
                    <input type="text" id="adm-task-val" placeholder="Nueva tarea de mantenimiento...">
                    <button class="btn-submit btn-gold" style="width:120px" onclick="window.pushTask()"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-protocol" class="modal-view">
        <div class="modal-wrapper">
            <h2 style="text-align:center; color:var(--dorado); margin-bottom:20px">PROTOCOLO OBLIGATORIO</h2>
            <p style="text-align:center; opacity:0.6; font-size:0.9rem; margin-bottom:40px">Marca las tareas concluidas para habilitar el cierre de sesión.</p>
            <div id="checklist-render-box" style="margin-bottom:45px; max-height:300px; overflow-y:auto"></div>
            <button class="btn-submit btn-gold" style="height:100px" onclick="window.finishPunchOut()">AUTORIZAR SALIDA</button>
        </div>
    </div>

    <nav id="tab-bar">
        <div class="tab-item" id="t-finanzas" onclick="window.nav('finanzas')"><i class="fa-solid fa-vault"></i><span>Capital</span></div>
        <div class="tab-item" id="t-agenda" onclick="window.nav('agenda')"><i class="fa-solid fa-calendar-alt"></i><span>Agenda</span></div>
        <div class="tab-item" id="t-reloj" onclick="window.nav('reloj')"><i class="fa-solid fa-fingerprint"></i><span>Reloj</span></div>
        <div class="tab-item" id="t-insumos" onclick="window.nav('insumos')"><i class="fa-solid fa-kitchen-set"></i><span>Bodega</span></div>
        <div class="tab-item" id="t-admin" onclick="window.nav('admin')"><i class="fa-solid fa-sliders"></i><span>Admin</span></div>
    </nav>

    <script type="module">
        /* ESCAROLA OS - CORE ENGINE v13.2
           Lógica distribuida para manejo de datos en tiempo real.
        */
        import { db, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, orderBy, limit } from './firebase-config.js';

        // Estado Global del Sistema
        window.tempPin = ""; 
        window.activeUser = null; 
        window.calendarRef = new Date();

        /* ==========================================================
           1. SISTEMA DE AUTENTICACIÓN (PINPAD)
           ========================================================== */
        window.typePin = (n) => {
            if(window.tempPin.length < 4) {
                window.tempPin += n;
                window.refreshPinSlots();
                if(window.tempPin.length === 4) {
                    // Pequeño retardo visual para que el usuario vea el último slot lleno
                    setTimeout(() => window.authSystem(), 180);
                }
            }
        };

        window.erasePin = () => { 
            window.tempPin = ""; 
            window.refreshPinSlots(); 
        };

        window.refreshPinSlots = () => {
            for(let i=1; i<=4; i++) {
                const s = document.getElementById(`slot-${i}`);
                if(i <= window.tempPin.length) s.classList.add('active');
                else s.classList.remove('active');
            }
        };

        window.authSystem = async () => {
            try {
                // El PIN se busca como cadena para mantener la integridad de ceros iniciales
                const userRef = collection(db, "usuarios");
                const q = query(userRef, where("pin", "==", window.tempPin));
                const querySnapshot = await getDocs(q);
                
                if(!querySnapshot.empty) {
                    const foundData = querySnapshot.docs[0].data();
                    window.activeUser = { id: querySnapshot.docs[0].id, ...foundData };
                    
                    // Transición exitosa
                    const loginScreen = document.getElementById('login-screen');
                    loginScreen.style.opacity = '0';
                    setTimeout(() => {
                        loginScreen.style.display = 'none';
                        document.getElementById('tab-bar').style.display = 'grid';
                        window.bootApp();
                    }, 500);
                } else {
                    window.showAlert("PIN DE ACCESO INCORRECTO", true);
                    window.erasePin();
                }
            } catch(err) { 
                console.error("Critical Auth Error:", err);
                window.showAlert("FALLA DE COMUNICACIÓN CON NÚCLEO", true);
            }
        };

        /* ==========================================================
           2. MOTOR DE NAVEGACIÓN Y PERMISOS
           ========================================================== */
        window.nav = (v) => {
            // Protección de datos financieros y administrativos
            if((v === 'finanzas' || v === 'admin') && window.activeUser.rol !== 'Socio') {
                return window.showAlert("PERMISOS DE SOCIO REQUERIDOS", true);
            }

            // Gestión de capas de visualización
            const views = document.querySelectorAll('.view-content');
            const tabs = document.querySelectorAll('.tab-item');
            
            views.forEach(view => view.style.display = 'none');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(`view-${v}`).style.display = 'block';
            document.getElementById(`t-${v}`).classList.add('active');
        };

        /* ==========================================================
           3. MÓDULO FINANCIERO (CAPITAL)
           ========================================================== */
        window.pushMoney = async (type) => {
            const val = parseFloat(document.getElementById('fin-val').value);
            const concept = document.getElementById('fin-concept').value;
            const acc = document.getElementById('fin-acc').value;
            const recId = document.getElementById('fin-recipe-link').value;

            if(!val || !concept) return window.showAlert("TODOS LOS CAMPOS SON OBLIGATORIOS", true);

            try {
                const entry = {
                    monto: val,
                    desc: concept,
                    metodo: acc,
                    tipo: type,
                    referencia: recId || null,
                    fecha: new Date().toISOString(),
                    operador: window.activeUser.nombre
                };

                await addDoc(collection(db, "finanzas"), entry);

                // Si es un ingreso vinculado a receta, descontar stock automáticamente
                if(type === 'INGRESO' && recId) {
                    await window.runAutoStockDeduct(recId);
                }

                window.showAlert("MOVIMIENTO REGISTRADO CON ÉXITO");
                document.getElementById('fin-val').value = "";
                document.getElementById('fin-concept').value = "";
                window.renderFinanceState();
            } catch(e) { window.showAlert("ERROR AL PROCESAR TRANSACCIÓN", true); }
        };

        window.renderFinanceState = async () => {
            const snap = await getDocs(query(collection(db, "finanzas"), orderBy("fecha", "desc")));
            let totalCaja = 0, totalBanco = 0, totalGasto = 0, totalVenta = 0;
            const logBox = document.getElementById('finance-log-render');
            logBox.innerHTML = "<h4 style='opacity:0.3; margin:40px 0 20px'>Historial de Operaciones</h4>";

            snap.forEach(d => {
                const f = d.data();
                if(f.tipo === 'INGRESO') {
                    totalVenta += f.monto;
                    if(f.metodo === 'CAJA') totalCaja += f.monto; else totalBanco += f.monto;
                } else {
                    totalGasto += f.monto;
                    if(f.metodo === 'CAJA') totalCaja -= f.monto; else totalBanco -= f.monto;
                }

                logBox.innerHTML += `
                    <div class="record-row" style="border-left-color:${f.tipo==='INGRESO'?'var(--dorado)':'var(--terracota)'}">
                        <div class="record-info">
                            <b>${f.desc}</b>
                            <small>${f.metodo} • ${new Date(f.fecha).toLocaleDateString()}</small>
                        </div>
                        <div style="text-align:right">
                            <b style="color:${f.tipo==='INGRESO'?'#fff':'var(--terracota)'}">${f.tipo==='INGRESO'?'+':'-'}$${f.monto.toFixed(2)}</b><br>
                            <button class="btn-delete" style="margin-top:10px" onclick="window.removeDoc('finanzas','${d.id}','renderFinanceState')"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>`;
            });

            document.getElementById('stat-caja').innerText = `$${totalCaja.toFixed(2)}`;
            document.getElementById('stat-banco').innerText = `$${totalBanco.toFixed(2)}`;
            document.getElementById('stat-gasto').innerText = `$${totalGasto.toFixed(2)}`;
            document.getElementById('stat-venta').innerText = `$${totalVenta.toFixed(2)}`;
            document.getElementById('net-wealth').innerText = `$${(totalCaja + totalBanco).toFixed(2)}`;
        };

        /* ==========================================================
           4. MÓDULO DE AGENDA Y CALENDARIO
           ========================================================== */
        window.renderCalMatrix = async () => {
            const body = document.getElementById('calendar-body');
            body.innerHTML = "";
            const mo = window.calendarRef.getMonth();
            const yr = window.calendarRef.getFullYear();
            
            document.getElementById('calendar-title').innerText = window.calendarRef.toLocaleDateString('es-MX', {month:'long', year:'numeric'});

            const labels = ["DOM", "LUN", "MAR", "MIÉ", "JUE", "VIE", "SÁB"];
            labels.forEach(l => body.innerHTML += `<div class="day-label">${l}</div>`);

            const startDay = new Date(yr, mo, 1).getDay();
            const daysInMo = new Date(yr, mo + 1, 0).getDate();
            const prevDays = new Date(yr, mo, 0).getDate();

            const agendaSnap = await getDocs(collection(db, "agenda"));
            let datesMarked = []; agendaSnap.forEach(e => datesMarked.push(e.data().fecha.split('T')[0]));

            for(let i = startDay; i > 0; i--) body.innerHTML += `<div class="day-square blur-day">${prevDays - i + 1}</div>`;

            for(let d = 1; d <= daysInMo; d++) {
                const dateKey = `${yr}-${(mo+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const isToday = new Date().toDateString() === new Date(yr, mo, d).toDateString();
                const hasData = datesMarked.includes(dateKey);

                body.innerHTML += `
                    <div class="day-square ${isToday?'active-day':''} ${hasData?'has-data':''}" onclick="window.openDay('${dateKey}')">
                        ${d}
                    </div>`;
            }
        };

        window.pushAgenda = async () => {
            const cli = document.getElementById('age-customer').value;
            const tim = document.getElementById('age-time').value;
            if(!cli || !tim) return;
            await addDoc(collection(db, "agenda"), { cliente: cli, fecha: tim, nota: document.getElementById('age-memo').value });
            window.showAlert("RESERVACIÓN CONFIRMADA"); window.renderCalMatrix();
        };

        window.openDay = async (key) => {
            const q = query(collection(db, "agenda"), where("fecha", ">=", key), where("fecha", "<=", key + "T23:59"));
            const s = await getDocs(q);
            const render = document.getElementById('agenda-day-render');
            render.innerHTML = `<h4 style="margin:30px 0 15px">Compromisos: ${key}</h4>`;
            if(s.empty) render.innerHTML += "<p style='opacity:0.2'>No hay eventos programados.</p>";
            s.forEach(doc => {
                const a = doc.data();
                render.innerHTML += `
                    <div class="record-row">
                        <div class="record-info"><b>${a.cliente}</b><small>${a.fecha.split('T')[1]}h</small></div>
                        <button class="btn-delete" onclick="window.removeDoc('agenda','${doc.id}','renderCalMatrix')"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
            });
        };

        /* ==========================================================
           5. CONTROL DE RELOJ Y ASISTENCIA
           ========================================================== */
        window.handlePunch = async (mode) => {
            if(mode === 'SALIDA') {
                const taskSnap = await getDocs(collection(db, "tareas"));
                let html = "";
                taskSnap.forEach(d => {
                    html += `<div style="padding:25px; border-bottom:1.5px solid #222; display:flex; gap:25px; align-items:center">
                        <input type="checkbox" class="task-check-item" style="width:35px; height:35px; border-radius:10px">
                        <span style="font-size:1.2rem; font-weight:600">${d.data().tarea}</span>
                    </div>`;
                });
                document.getElementById('checklist-render-box').innerHTML = html || "No hay tareas pendientes.";
                document.getElementById('modal-protocol').style.display = 'flex';
            } else {
                await window.executeSavePunch('ENTRADA');
            }
        };

        window.finishPunchOut = async () => {
            const items = document.querySelectorAll('.task-check-item');
            if(items.length > 0 && !Array.from(items).every(i => i.checked)) {
                return window.showAlert("PROTOCOLOS DE LIMPIEZA INCOMPLETOS", true);
            }
            await window.executeSaveSavePunch('SALIDA');
            location.reload(); 
        };

        window.executeSavePunch = async (t) => {
            await addDoc(collection(db, "asistencias"), {
                uid: window.activeUser.id,
                staff: window.activeUser.nombre,
                accion: t,
                momento: new Date().toISOString()
            });
            window.showAlert("OPERACIÓN " + t + " REGISTRADA");
            window.renderPunchHistory();
        };

        window.renderPunchHistory = async () => {
            const q = query(collection(db, "asistencias"), orderBy("momento", "desc"), limit(10));
            const s = await getDocs(q);
            const box = document.getElementById('punch-log-render');
            box.innerHTML = "<h4 style='opacity:0.3; margin-bottom:25px'>Registros de Jornada (Hoy)</h4>";
            s.forEach(d => {
                const p = d.data();
                box.innerHTML += `<div class="record-row"><span>${p.staff}</span> <b style="color:var(--dorado)">${p.accion}</b></div>`;
            });
        };

        /* ==========================================================
           6. BODEGA, STOCK Y RECETARIO
           ========================================================== */
        window.pushStock = async () => {
            const n = document.getElementById('ins-title').value;
            const q = parseFloat(document.getElementById('ins-quantity').value);
            const u = document.getElementById('ins-unit').value;
            const a = parseFloat(document.getElementById('ins-alert').value || 0);
            if(!n || isNaN(q)) return;
            await addDoc(collection(db, "inventario"), { nombre: n, stock: q, unidad: u, minimo: a });
            window.showAlert("INVENTARIO ACTUALIZADO"); window.renderInventory();
        };

        window.renderInventory = async () => {
            const s = await getDocs(collection(db, "inventario"));
            const l = document.getElementById('stock-log-render');
            l.innerHTML = "<h4 style='opacity:0.3; margin:35px 0 20px'>Existencias en Bodega</h4>";
            s.forEach(d => {
                const i = d.data();
                const isLow = i.stock <= i.minimo;
                l.innerHTML += `
                    <div class="record-row ${isLow?'critical-pulse':''}">
                        <div class="record-info"><b>${i.nombre}</b><small>Alerta bajo: ${i.minimo} ${i.unidad}</small></div>
                        <div style="text-align:right">
                            <b style="font-size:1.6rem">${i.stock} <small>${i.unidad}</small></b><br>
                            <button class="btn-delete" style="margin-top:10px" onclick="window.removeDoc('inventario','${d.id}','renderInventory')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        };

        window.appendIngRow = () => {
            const wrap = document.createElement('div');
            wrap.style.display = 'grid'; wrap.style.gridTemplateColumns = '2fr 1fr'; wrap.style.gap = '20px'; wrap.style.marginBottom = '15px';
            wrap.innerHTML = `<input type="text" class="ri-n" placeholder="Insumo"><input type="number" class="ri-q" placeholder="Cant.">`;
            document.getElementById('rec-ing-container').appendChild(wrap);
        };

        window.pushRecipe = async () => {
            const tit = document.getElementById('rec-title').value;
            const ings = [];
            const nNodes = document.querySelectorAll('.ri-n');
            const qNodes = document.querySelectorAll('.ri-q');
            nNodes.forEach((node, i) => { if(node.value) ings.push({ n: node.value, q: parseFloat(qNodes[i].value) }); });
            await addDoc(collection(db, "recetas"), { platillo: tit, componentes: ings });
            window.showAlert("RECETA MAESTRA GUARDADA"); window.renderRecipes();
        };

        window.renderRecipes = async () => {
            const snap = await getDocs(collection(db, "recetas"));
            const log = document.getElementById('recipe-log-render');
            const sel = document.getElementById('fin-recipe-link');
            log.innerHTML = ""; sel.innerHTML = "<option value=''>-- Sin receta vinculada --</option>";
            snap.forEach(d => {
                log.innerHTML += `<div class="record-row"><b>${d.data().platillo}</b><button class="btn-delete" onclick="window.removeDoc('recetas','${d.id}','renderRecipes')"><i class="fa-solid fa-trash-can"></i></button></div>`;
                sel.innerHTML += `<option value="${d.id}">${d.data().platillo}</option>`;
            });
        };

        window.runAutoStockDeduct = async (recipeId) => {
            const allRecs = await getDocs(collection(db, "recetas"));
            const targetRec = allRecs.docs.find(d => d.id === recipeId).data();
            for(let component of targetRec.componentes) {
                const stockQuery = query(collection(db, "inventario"), where("nombre", "==", component.n));
                const stockSnap = await getDocs(stockQuery);
                if(!stockSnap.empty) {
                    const item = stockSnap.docs[0];
                    await updateDoc(doc(db, "inventario", item.id), { stock: item.data().stock - component.q });
                }
            }
            window.renderInventory();
        };

        /* ==========================================================
           7. ADMINISTRACIÓN (PERSONAL Y TAREAS)
           ========================================================== */
        window.pushUser = async () => {
            const n = document.getElementById('adm-name').value;
            const p = document.getElementById('adm-pin').value;
            const s = document.getElementById('adm-wage').value;
            const r = document.getElementById('adm-role').value;
            if(!n || p.length !== 4) return window.showAlert("PIN DEBE SER DE 4 DÍGITOS", true);
            await addDoc(collection(db, "usuarios"), { nombre: n, pin: p.toString(), sueldo: parseFloat(s), rol: r });
            window.showAlert("COLABORADOR REGISTRADO"); window.renderAdminLog();
        };

        window.pushTask = async () => {
            const t = document.getElementById('adm-task-val').value;
            if(!t) return;
            await addDoc(collection(db, "tareas"), { tarea: t });
            document.getElementById('adm-task-val').value = ""; window.renderAdminLog();
        };

        window.renderAdminLog = async () => {
            const uSnap = await getDocs(collection(db, "usuarios"));
            const tSnap = await getDocs(collection(db, "tareas"));
            const uLog = document.getElementById('user-log-render');
            const tLog = document.getElementById('task-log-render');
            uLog.innerHTML = "<h4>Staff Activo en Sistema</h4>";
            uSnap.forEach(d => uLog.innerHTML += `<div class="record-row"><span>${d.data().nombre} (${d.data().rol})</span><button class="btn-delete" onclick="window.removeDoc('usuarios','${d.id}','renderAdminLog')"><i class="fa-solid fa-trash"></i></button></div>`);
            tLog.innerHTML = "";
            tSnap.forEach(d => tLog.innerHTML += `<div class="record-row"><span>${d.data().tarea}</span><button class="btn-delete" onclick="window.removeDoc('tareas','${d.id}','renderAdminLog')"><i class="fa-solid fa-trash"></i></button></div>`);
        };

        /* ==========================================================
           8. UTILIDADES DE SISTEMA Y BOOT
           ========================================================== */
        window.showAlert = (m, e = false) => {
            const t = document.getElementById('toast-manager'); 
            t.innerText = m; t.style.display = 'block';
            t.style.background = e ? 'var(--terracota)' : 'var(--dorado)';
            t.style.color = e ? '#fff' : 'var(--verde-oscuro)';
            setTimeout(() => t.style.display = 'none', 4000);
        };

        window.removeDoc = async (c, id, callback) => {
            if(confirm("¿CONFIRMAS LA ELIMINACIÓN PERMANENTE?")) {
                await deleteDoc(doc(db, c, id));
                if(window[callback]) window[callback]();
            }
        };

        window.changeMo = (n) => { 
            window.calendarRef.setMonth(window.calendarRef.getMonth() + n); 
            window.renderCalMatrix(); 
        };

        window.bootApp = () => {
            // Decidir vista inicial por rol
            window.nav(window.activeUser.rol === 'Socio' ? 'finanzas' : 'reloj');
            
            // Cargas paralelas
            window.renderCalMatrix(); 
            window.renderPunchHistory(); 
            window.renderInventory(); 
            window.renderRecipes();
            
            if(window.activeUser.rol === 'Socio') { 
                window.renderFinanceState(); 
                window.renderAdminLog(); 
            }
            
            // Reloj en tiempo real
            setInterval(() => {
                const now = new Date();
                document.getElementById('digital-clock').innerText = now.toLocaleTimeString('es-MX', {hour12:false});
                document.getElementById('digital-date').innerText = now.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'long'});
            }, 1000);
        };
    </script>
</body>
</html>
