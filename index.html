<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EscarolaOS - Sistema Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --verde-bosque: #1b3022;
            --verde-oscuro: #14241a;
            --terracota: #b0413e;
            --cantera: #d9d4c7;
            --dorado: #c5a059;
            --negro: #0a0a0a;
            --blanco-trans: rgba(217, 212, 199, 0.1);
            --sombra: 0 10px 30px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--verde-bosque); 
            color: var(--cantera); 
            margin: 0; padding: 0; 
            height: 100vh; overflow-x: hidden;
        }

        /* --- PANTALLA PIN --- */
        #login-screen {
            position: fixed; inset: 0; background: var(--verde-bosque);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9000;
        }
        .logo-box { text-align: center; margin-bottom: 30px; }
        .logo-box h1 { font-size: 2.2rem; letter-spacing: 12px; margin: 0; }
        .logo-box span { color: var(--dorado); }

        .dot-container { display: flex; gap: 15px; margin-bottom: 40px; }
        .dot { width: 16px; height: 16px; border: 2px solid var(--dorado); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--dorado); box-shadow: 0 0 15px var(--dorado); }

        .grid-pin { display: grid; grid-template-columns: repeat(3, 80px); gap: 15px; }
        .btn-pin {
            width: 80px; height: 80px; border-radius: 50%; border: 1px solid var(--dorado);
            background: var(--verde-oscuro); color: var(--dorado); font-size: 1.4rem;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-pin:active { background: var(--dorado); color: var(--verde-oscuro); transform: scale(0.9); }

        /* --- NAVEGACIÓN --- */
        #main-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 500px; background: rgba(20, 36, 26, 0.95);
            backdrop-filter: blur(10px); display: none; grid-template-columns: repeat(5, 1fr);
            border-radius: 40px; border: 1px solid var(--dorado); padding: 10px; z-index: 5000;
            box-shadow: var(--sombra);
        }
        .tab-item { text-align: center; color: var(--cantera); opacity: 0.4; cursor: pointer; font-size: 0.6rem; text-transform: uppercase; }
        .tab-item.active { opacity: 1; color: var(--dorado); }
        .tab-item i { font-size: 1.2rem; display: block; margin-bottom: 4px; }

        /* --- CONTENEDORES --- */
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 20px; display: none; padding-bottom: 120px; }
        .card { background: var(--verde-oscuro); border-radius: 25px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--blanco-trans); box-shadow: var(--sombra); }
        
        .btn-pill { border-radius: 50px; border: none; padding: 12px 15px; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; font-size: 0.75rem; transition: 0.3s; }
        .btn-gold { background: var(--dorado); color: var(--verde-oscuro); }
        .btn-green { background: var(--verde-oscuro); color: var(--dorado); border: 1px solid var(--dorado); }
        .btn-red { background: var(--terracota); color: white; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; background: var(--negro); border: 1px solid var(--blanco-trans); border-radius: 12px; color: var(--cantera); }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--dorado); color: var(--verde-oscuro); padding: 10px 25px; border-radius: 50px; font-weight: bold; display: none; z-index: 10000; }

        /* Estilo para Checklist */
        .check-row { display: flex; align-items: center; gap: 12px; background: var(--blanco-trans); padding: 12px; border-radius: 15px; margin-bottom: 8px; cursor: pointer; }
        .check-row input { width: 20px; height: 20px; margin: 0; accent-color: var(--dorado); }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="login-screen">
        <div class="logo-box"><h1>ESCAROLA<span>OS</span></h1><p style="color:var(--dorado); letter-spacing:3px; font-size:0.6rem;">MASTER CONTROL</p></div>
        <div class="dot-container">
            <div class="dot" id="d0"></div><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div>
        </div>
        <div class="grid-pin" id="pin-board">
            <button class="btn-pin" data-val="1">1</button><button class="btn-pin" data-val="2">2</button><button class="btn-pin" data-val="3">3</button>
            <button class="btn-pin" data-val="4">4</button><button class="btn-pin" data-val="5">5</button><button class="btn-pin" data-val="6">6</button>
            <button class="btn-pin" data-val="7">7</button><button class="btn-pin" data-val="8">8</button><button class="btn-pin" data-val="9">9</button>
            <button class="btn-pin" style="color:var(--terracota)" data-val="C">C</button><button class="btn-pin" data-val="0">0</button><button class="btn-pin" data-val="R"><i class="fa-solid fa-rotate"></i></button>
        </div>
    </div>

    <nav id="main-nav">
        <div class="tab-item active" id="tab-finanzas" onclick="showTab('finanzas')"><i class="fa-solid fa-chart-line"></i>Finanzas</div>
        <div class="tab-item" id="tab-agenda" onclick="showTab('agenda')"><i class="fa-solid fa-calendar-alt"></i>Agenda</div>
        <div class="tab-item" id="tab-reloj" onclick="showTab('reloj')"><i class="fa-solid fa-clock"></i>Reloj</div>
        <div class="tab-item" id="tab-cocina" onclick="showTab('cocina')"><i class="fa-solid fa-utensils"></i>Cocina</div>
        <div class="tab-item" id="tab-admin" onclick="showTab('admin')"><i class="fa-solid fa-user-shield"></i>Admin</div>
    </nav>

    <div id="finanzas" class="container">
        <h2 style="color:var(--dorado)">Capital & Balance</h2>
        <div class="card" style="border-left: 5px solid var(--dorado)">
            <small>UTILIDAD ESTIMADA</small>
            <h1 id="total-balance" style="font-size: 2.8rem; margin: 5px 0">$0.00</h1>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem">
                <span style="color:var(--dorado)">Ingresos: <b id="ing-val">$0</b></span>
                <span style="color:var(--terracota)">Gastos: <b id="gas-val">$0</b></span>
            </div>
        </div>
        <div class="card">
            <h4><i class="fa-solid fa-qrcode"></i> Escáner de Facturas</h4>
            <button class="btn-pill btn-gold" onclick="alert('Iniciando Cámara IA...')">SUBIR TICKET</button>
        </div>
    </div>

    <div id="agenda" class="container">
        <h2 style="color:var(--dorado)">Reservas y Eventos</h2>
        <div id="calendar-card" class="card">
            </div>
    </div>

    <div id="reloj" class="container">
        <h2 style="color:var(--dorado)">Asistencia Personal</h2>
        <div class="card" style="text-align:center">
            <h1 id="live-clock" style="font-size:3.5rem; margin:0">00:00</h1>
            <p id="live-date" style="color:var(--dorado); margin:0">FECHA</p>
        </div>
        <div style="display:flex; gap:15px">
            <button class="btn-pill btn-green" style="height:80px; font-size:1.2rem" onclick="marcarEntrada()">ENTRADA</button>
            <button class="btn-pill btn-red" style="height:80px; font-size:1.2rem" onclick="marcarSalida()">SALIDA</button>
        </div>
    </div>

    <div id="cocina" class="container">
        <h2 style="color:var(--dorado)">Recetario e Inventario</h2>
        <div class="card">
            <button class="btn-pill btn-gold" onclick="document.getElementById('excel-input').click()">IMPORTAR EXCEL RECETAS</button>
            <input type="file" id="excel-input" hidden accept=".xlsx, .xls">
        </div>
        <div id="lista-insumos-alerta"></div>
    </div>

    <div id="admin" class="container">
        <h2 style="color:var(--dorado)">Configuración Máster</h2>
        <div class="card">
            <h4>Gestionar Checklist de Limpieza</h4>
            <div id="admin-tasks-list"></div>
            <div style="display:flex; gap:10px; margin-top:10px">
                <input type="text" id="new-task-input" placeholder="Ej: Limpiar freidora">
                <button class="btn-pill btn-gold" style="width:50px" onclick="addChecklistTask()">+</button>
            </div>
        </div>
    </div>

    <div id="modal-container" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center; padding:20px;">
        <div class="card" style="width:100%; max-width:450px; position:relative">
            <button onclick="closeModal()" style="position:absolute; top:15px; right:15px; background:none; border:none; color:var(--terracota); font-size:1.5rem">✕</button>
            <div id="modal-content"></div>
        </div>
    </div>
<script type="module">
        // 1. CONFIGURACIÓN Y CONEXIÓN
        import { db, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, orderBy, limit } from './firebase-config.js';

        let currentPin = "";
        window.usuarioActual = null;
        let tareasLimpieza = [];

        // 2. LÓGICA DEL PINPAD (REFORZADA)
        document.getElementById('pin-board').addEventListener('click', (e) => {
            const val = e.target.closest('button')?.dataset.val;
            if (!val) return;

            if (val === 'C') { 
                currentPin = ""; 
                updateDots(); 
            } else if (val === 'R') { 
                location.reload(); 
            } else {
                if (currentPin.length < 4) {
                    currentPin += val;
                    updateDots();
                    if (currentPin.length === 4) {
                        setTimeout(checkAccess, 200);
                    }
                }
            }
        });

        function updateDots() {
            for (let i = 0; i < 4; i++) {
                document.getElementById(`d${i}`).classList.toggle('active', i < currentPin.length);
            }
        }

        // 3. CONTROL DE ACCESO Y SEGURIDAD
        async function checkAccess() {
            showToast("VERIFICANDO...");
            try {
                const q = query(collection(db, "usuarios"), where("pin", "==", currentPin));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    const docUser = snap.docs[0];
                    window.usuarioActual = { id: docUser.id, ...docUser.data() };
                    
                    showToast(`¡HOLA, ${window.usuarioActual.nombre.toUpperCase()}!`);
                    
                    // Transición al Dashboard
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-nav').style.display = 'grid';
                    
                    iniciarReloj();
                    configurarEntornoPorRol();
                } else {
                    showToast("PIN INCORRECTO", true);
                    currentPin = "";
                    updateDots();
                }
            } catch (err) {
                showToast("ERROR DE CONEXIÓN", true);
                currentPin = "";
                updateDots();
            }
        }

        function configurarEntornoPorRol() {
            const esSocio = window.usuarioActual.rol === 'Socio';
            
            if (esSocio) {
                showTab('finanzas');
                cargarConfiguracionAdmin();
            } else {
                showTab('reloj');
                // Ocultar pestañas restringidas
                document.getElementById('tab-finanzas').style.display = 'none';
                document.getElementById('tab-admin').style.display = 'none';
                document.getElementById('main-nav').style.gridTemplateColumns = 'repeat(3, 1fr)';
            }
        }

        // 4. NAVEGACIÓN ENTRE MÓDULOS
        window.showTab = (tabId) => {
            document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabId).style.display = 'block';
            document.getElementById('tab-' + tabId).classList.add('active');
            window.scrollTo(0,0);
        };

        // 5. RELOJ Y FECHA EN TIEMPO REAL
        function iniciarReloj() {
            setInterval(() => {
                const ahora = new Date();
                document.getElementById('live-clock').innerText = ahora.toLocaleTimeString('es-MX', { hour12: false });
                document.getElementById('live-date').innerText = ahora.toLocaleDateString('es-MX', { 
                    weekday: 'long', day: 'numeric', month: 'long' 
                }).toUpperCase();
            }, 1000);
        }

        // 6. UTILIDADES DE NOTIFICACIÓN (TOAST)
        window.showToast = (msg, error = false) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            t.style.background = error ? 'var(--terracota)' : 'var(--dorado)';
            setTimeout(() => { t.style.display = 'none'; }, 2500);
        };

        window.closeModal = () => {
            document.getElementById('modal-container').style.display = 'none';
        };

        // Exportar funciones para uso en HTML
        window.checkAccess = checkAccess;
    // --- 7. LÓGICA DE ASISTENCIA (RRHH) ---
        window.marcarEntrada = async () => {
            if(!window.usuarioActual) return;
            try {
                // Verificar último registro para evitar doble entrada
                const q = query(collection(db, "asistencias"), where("uid", "==", window.usuarioActual.id), orderBy("hora", "desc"), limit(1));
                const snap = await getDocs(q);
                const ultimo = snap.empty ? null : snap.docs[0].data();

                if(ultimo && ultimo.tipo === "ENTRADA") {
                    showToast("YA TIENES UNA ENTRADA ACTIVA", true);
                    return;
                }

                await addDoc(collection(db, "asistencias"), {
                    uid: window.usuarioActual.id,
                    nombre: window.usuarioActual.nombre,
                    tipo: "ENTRADA",
                    hora: new Date().toISOString(),
                    sueldoBase: window.usuarioActual.sueldo || 0,
                    pagado: false
                });
                showToast("ENTRADA REGISTRADA");
            } catch (e) { showToast("ERROR AL REGISTRAR", true); }
        };

        window.marcarSalida = async () => {
            // 1. Cargar tareas de limpieza vigentes
            const snap = await getDocs(collection(db, "checklist"));
            if(snap.empty) {
                ejecutarSalida();
                return;
            }

            // 2. Mostrar Checklist Obligatorio en Modal
            let html = `<h3 style="color:var(--dorado); margin-top:0">Checklist de Cierre</h3>
                        <p style="font-size:0.8rem; margin-bottom:15px">Debes completar todo para finalizar turno:</p>`;
            
            snap.forEach((d, i) => {
                const t = d.data();
                html += `<div class="check-row" onclick="document.getElementById('task-${i}').click()">
                            <input type="checkbox" id="task-${i}" class="task-confirm">
                            <span>${t.tarea}</span>
                         </div>`;
            });

            html += `<button class="btn-pill btn-gold" style="margin-top:15px" onclick="validarYSalir()">CONFIRMAR Y SALIR</button>`;
            
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-container').style.display = 'flex';
        };

        window.validarYSalir = () => {
            const total = document.querySelectorAll('.task-confirm').length;
            const marcadas = document.querySelectorAll('.task-confirm:checked').length;

            if(marcadas < total) {
                showToast("FALTAN TAREAS POR COMPLETAR", true);
                return;
            }
            closeModal();
            ejecutarSalida();
        };

        async function ejecutarSalida() {
            try {
                await addDoc(collection(db, "asistencias"), {
                    uid: window.usuarioActual.id,
                    nombre: window.usuarioActual.nombre,
                    tipo: "SALIDA",
                    hora: new Date().toISOString(),
                    pagado: false
                });
                showToast("SALIDA REGISTRADA. ¡BUEN DESCANSO!");
            } catch (e) { showToast("ERROR AL SALIR", true); }
        }

        // --- 8. CONFIGURACIÓN DE TAREAS (ADMIN) ---
        window.cargarConfiguracionAdmin = async () => {
            const cont = document.getElementById('admin-tasks-list');
            if(!cont) return;
            
            const snap = await getDocs(collection(db, "checklist"));
            cont.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                cont.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid var(--blanco-trans)">
                    <span>${t.tarea}</span>
                    <button onclick="eliminarTarea('${d.id}')" style="background:none; border:none; color:var(--terracota); cursor:pointer"><i class="fa-solid fa-trash"></i></button>
                </div>`;
            });
        };

        window.addChecklistTask = async () => {
            const input = document.getElementById('new-task-input');
            if(!input.value) return;
            
            await addDoc(collection(db, "checklist"), { tarea: input.value });
            input.value = "";
            showToast("TAREA AGREGADA");
            cargarConfiguracionAdmin();
        };

        window.eliminarTarea = async (id) => {
            if(!confirm("¿Eliminar esta tarea del checklist?")) return;
            await deleteDoc(doc(db, "checklist", id));
            cargarConfiguracionAdmin();
        };
    </script>

