<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EscarolaOS v15.0 - Enterprise Robust Architecture</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           SISTEMA DE DISEÑO ESCAROLA OS PREMIUM
           ========================================= 
        */
        :root {
            --verde-bosque: #1b3022;
            --verde-oscuro: #0d1a12;
            --terracota: #b0413e;
            --cantera: #d9d4c7;
            --dorado: #c5a059;
            --negro: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(197, 160, 89, 0.3);
            --pill: 50px;
            --shadow-premium: 0 20px 40px rgba(0,0,0,0.8);
            --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* RESET SISTÉMICO */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--verde-bosque); 
            color: var(--cantera); 
            height: 100vh; 
            overflow: hidden; 
            user-select: none;
        }

        /* ANIMACIONES DE ALTA FIDELIDAD */
        @keyframes glowPulse {
            0%, 100% { filter: drop-shadow(0 0 5px var(--dorado)); opacity: 0.8; }
            50% { filter: drop-shadow(0 0 25px var(--dorado)); opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           SISTEMA DE ACCESO (LOGIN & PINPAD)
           ========================================= 
        */
        #login-screen { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at center, var(--verde-bosque) 0%, var(--negro) 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 999999; padding: 20px;
        }

        .login-wrapper {
            display: flex; flex-direction: column; align-items: center;
            max-width: 380px; width: 100%;
            animation: slideUp 0.8s ease;
        }

        .logo-box { 
            width: 110px; height: auto; margin-bottom: 25px; 
            animation: glowPulse 4s infinite ease-in-out; 
        }

        .pin-indicator { display: flex; margin-bottom: 40px; gap: 18px; }
        .dot { 
            width: 18px; height: 18px; border: 2px solid var(--dorado); border-radius: 50%; 
            transition: var(--transition); 
        }
        .dot.active { background: var(--dorado); box-shadow: 0 0 15px var(--dorado); transform: scale(1.3); }

        .numpad-container {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            width: 100%;
        }

        .key {
            aspect-ratio: 1; border-radius: 50%; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.6rem; color: var(--dorado); background: var(--glass);
            cursor: pointer; transition: var(--transition);
        }
        .key:hover { background: rgba(197, 160, 89, 0.1); border-color: var(--dorado); }
        .key:active { transform: scale(0.85); background: var(--dorado); color: var(--negro); }

        /* =========================================
           CONTENEDOR PRINCIPAL
           ========================================= 
        */
        .main-viewport { 
            display: none; height: 100vh; overflow-y: auto; 
            padding: 35px 20px 200px 20px; max-width: 850px; margin: 0 auto;
            scroll-behavior: smooth;
        }

        .card-panel { 
            background: var(--verde-oscuro); border-radius: 35px; 
            padding: 30px; margin-bottom: 25px; border: 1px solid var(--border); 
            box-shadow: var(--shadow-premium); 
            animation: slideUp 0.5s ease;
        }

        .tag-header { 
            border-left: 6px solid var(--dorado); padding-left: 18px; 
            margin-bottom: 25px; letter-spacing: 4px; text-transform: uppercase; 
            font-size: 0.75rem; color: var(--dorado); font-weight: 900;
        }

        /* ELEMENTOS FORMULARES */
        .input-premium { 
            width: 100%; padding: 18px 28px; border-radius: var(--pill); 
            background: rgba(0,0,0,0.6); border: 1px solid var(--border); 
            color: #fff; margin-bottom: 15px; font-size: 1rem; outline: none;
            transition: var(--transition);
        }
        .input-premium:focus { border-color: var(--dorado); box-shadow: 0 0 15px rgba(197, 160, 89, 0.2); }

        .btn-premium { 
            width: 100%; padding: 20px; border-radius: var(--pill); border: none; 
            font-weight: 900; letter-spacing: 2px; text-transform: uppercase; 
            cursor: pointer; transition: var(--transition); 
            display: flex; align-items: center; justify-content: center; gap: 12px;
            font-size: 0.85rem;
        }
        .gold-btn { background: var(--dorado); color: var(--negro); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .red-btn { background: var(--terracota); color: #fff; }
        .btn-premium:active { transform: scale(0.96); opacity: 0.9; }

        .list-row { 
            background: var(--glass); padding: 18px 25px; border-radius: var(--pill); 
            margin-bottom: 12px; display: flex; justify-content: space-between; 
            align-items: center; border: 1px solid rgba(255,255,255,0.06); 
            transition: var(--transition);
        }
        .list-row:hover { background: rgba(255,255,255,0.08); }

        /* CALENDARIO PREMIUM */
        .cal-box { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 20px; }
        .cal-unit { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            background: rgba(255,255,255,0.03); border-radius: 15px; font-size: 0.9rem; 
            cursor: pointer; border: 1px solid transparent; transition: var(--transition);
        }
        .cal-unit.active { background: var(--dorado); color: var(--negro); font-weight: 900; transform: scale(1.1); }
        .cal-unit.marked { border-bottom: 4px solid var(--terracota); }

        /* BARRA DE COMANDO (BOTTOM NAV) */
        #command-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            width: 92%; max-width: 650px; background: rgba(13, 26, 18, 0.98); 
            border-radius: var(--pill); display: none; grid-template-columns: repeat(6, 1fr); 
            padding: 15px; border: 1px solid var(--dorado); 
            backdrop-filter: blur(25px); z-index: 9999; box-shadow: var(--shadow-premium);
        }
        .cmd-item { text-align: center; color: var(--cantera); opacity: 0.4; font-size: 0.6rem; font-weight: 800; cursor: pointer; text-decoration: none; }
        .cmd-item.active { opacity: 1; color: var(--dorado); }
        .cmd-item i { font-size: 1.6rem; display: block; margin-bottom: 6px; }

        /* GRÁFICA DE ANALÍTICA */
        .metric-bar { height: 18px; background: #000; border-radius: 10px; overflow: hidden; margin: 20px 0; display: flex; border: 1px solid var(--border); }
        .chunk-v { background: var(--dorado); height: 100%; transition: width 1s cubic-bezier(0.19, 1, 0.22, 1); }
        .chunk-g { background: var(--terracota); height: 100%; transition: width 1s cubic-bezier(0.19, 1, 0.22, 1); }

        /* NOTIFICACIONES */
        .modal-os { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); 
            z-index: 1000000; align-items: center; justify-content: center; padding: 25px; 
            backdrop-filter: blur(15px);
        }
        .modal-os-box { 
            background: var(--verde-oscuro); padding: 45px; border-radius: 45px; 
            width: 100%; max-width: 450px; border: 1px solid var(--dorado); text-align: center; 
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-wrapper">
            <img src="logo.png" class="logo-box" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3448/3448636.png'">
            <h2 style="letter-spacing: 8px; margin-bottom: 35px; font-weight: 200; font-size: 1.2rem;">ESCAROLA <span style="font-weight:900; color:var(--dorado)">OS</span></h2>
            
            <div class="pin-indicator">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            
            <div id="numpad-logic" class="numpad-container">
                </div>
        </div>
    </div>

    <div id="os-shell">
        
        <div id="view-finanzas" class="main-viewport">
            <div class="card-panel" style="text-align:center; padding: 50px 20px;">
                <span style="font-size:0.8rem; letter-spacing:5px; opacity:0.6; text-transform:uppercase">Capital Disponible</span>
                <h1 id="neto-val" style="font-size:4rem; margin:15px 0; font-weight: 900;">$0.00</h1>
                <p id="label-status-fin" style="font-size:0.7rem; color:var(--dorado); letter-spacing:2px"></p>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-bottom:25px">
                <div class="card-panel" style="margin:0; padding:25px; border-color: var(--dorado);">
                    <div style="text-align:center">
                        <span style="font-size:0.65rem; opacity:0.5">INGRESOS (POS)</span>
                        <h2 id="total-v" style="color:var(--dorado); margin-top:5px">$0</h2>
                    </div>
                </div>
                <div class="card-panel" style="margin:0; padding:25px; border-color: var(--terracota);">
                    <div style="text-align:center">
                        <span style="font-size:0.65rem; opacity:0.5">EGRESOS (DOCS)</span>
                        <h2 id="total-g" style="color:var(--terracota); margin-top:5px">$0</h2>
                    </div>
                </div>
            </div>

            <div class="card-panel">
                <div class="tag-header">Balance de Operación Mensual</div>
                <div class="metric-bar">
                    <div id="bar-v" class="chunk-v"></div>
                    <div id="bar-g" class="chunk-g"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:700">
                    <span id="perc-utilidad" style="color:var(--dorado)">0% UTILIDAD</span>
                    <span style="opacity:0.4">ANÁLISIS DE FLUJO</span>
                </div>
            </div>

            <div class="card-panel">
                <div class="tag-header">Asentar Nuevo Movimiento</div>
                <input type="text" id="f-desc" class="input-premium" placeholder="Descripción del movimiento">
                <input type="number" id="f-monto" class="input-premium" placeholder="Monto total $">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px">
                    <select id="f-tipo" class="input-premium" style="margin:0">
                        <option value="INGRESO">Entrada (+)</option>
                        <option value="GASTO">Salida (-)</option>
                    </select>
                    <select id="f-canal" class="input-premium" style="margin:0">
                        <option value="CAJA">Caja Efectivo</option>
                        <option value="BANCO">Transferencia</option>
                    </select>
                </div>
                <button class="btn-premium gold-btn" onclick="window.saveFinance()"><i class="fa-solid fa-file-invoice-dollar"></i> CONFIRMAR REGISTRO</button>
            </div>
            <div id="lista-finanzas"></div>
        </div>

        <div id="view-agenda" class="main-viewport">
            <div class="card-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px">
                    <button onclick="window.navMonth(-1)" class="btn-premium" style="width:60px; background:var(--glass); padding:0"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="cal-month-display" style="font-size:1.2rem; letter-spacing:4px; text-transform:uppercase; font-weight:900">ENERO 2026</h2>
                    <button onclick="window.navMonth(1)" class="btn-premium" style="width:60px; background:var(--glass); padding:0"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div id="cal-grid-render" class="cal-box"></div>
            </div>
            
            <div class="card-panel">
                <div class="tag-header" id="cal-selected-label">Selecciona una fecha</div>
                <input type="text" id="ev-tit" class="input-premium" placeholder="Asunto / Reservación">
                <input type="time" id="ev-hor" class="input-premium">
                <button class="btn-premium gold-btn" onclick="window.saveEvent()"><i class="fa-solid fa-calendar-check"></i> AGENDAR EVENTO</button>
            </div>
            <div id="lista-agenda"></div>
        </div>

        <div id="view-reloj" class="main-viewport">
            <div class="card-panel" style="text-align:center; padding:80px 0; border:2px solid var(--dorado); background: radial-gradient(circle, #1a2a1f 0%, #000 100%);">
                <h1 id="live-time" style="font-size:5rem; font-weight:100; letter-spacing: -3px;">00:00:00</h1>
                <p id="live-date" style="color:var(--dorado); letter-spacing:6px; font-weight:900; text-transform:uppercase; margin-top:15px"></p>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px; margin-top:25px">
                <button class="btn-premium gold-btn" style="height:200px; flex-direction:column" onclick="window.handlePunch('ENTRADA')">
                    <i class="fa-solid fa-fingerprint fa-4x"></i><br>MARCAR ENTRADA
                </button>
                <button class="btn-premium red-btn" style="height:200px; flex-direction:column" onclick="window.handlePunch('SALIDA')">
                    <i class="fa-solid fa-door-open fa-4x"></i><br>MARCAR SALIDA
                </button>
            </div>
            <div id="lista-asistencias" style="margin-top:40px"></div>
        </div>

        <div id="view-bodega" class="main-viewport">
            <div class="card-panel">
                <div class="tag-header">Gestión de Stock y Almacén</div>
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:15px">
                    <input type="text" id="inv-nom" class="input-premium" placeholder="Nombre de insumo">
                    <input type="number" id="inv-can" class="input-premium" placeholder="Cant.">
                </div>
                <button class="btn-premium gold-btn" onclick="window.saveInv()"><i class="fa-solid fa-boxes-stacked"></i> ACTUALIZAR INVENTARIO</button>
                <div id="lista-inventario" style="margin-top:25px"></div>
            </div>

            <div class="card-panel">
                <div class="tag-header">Recetario Estándar y Costeo</div>
                <input type="text" id="rec-nom" class="input-premium" placeholder="Nombre del Platillo">
                <input type="number" id="rec-cos" class="input-premium" placeholder="Costo Sugerido de Producción $">
                <textarea id="rec-det" class="input-premium" placeholder="Ingredientes y pasos de preparación..." style="height:120px; border-radius:25px; padding-top:20px"></textarea>
                <button class="btn-premium gold-btn" onclick="window.saveRecipe()"><i class="fa-solid fa-mortar-pestle"></i> REGISTRAR RECETA</button>
                <div id="lista-recetas" style="margin-top:25px"></div>
            </div>
        </div>

        <div id="view-admin" class="main-viewport">
            <div class="card-panel">
                <div class="tag-header">Cálculo de Nómina Activa</div>
                <p style="font-size:0.65rem; opacity:0.5; margin-bottom:20px">Horas calculadas desde la última fecha de pago registrada.</p>
                <div id="render-nomina"></div>
            </div>

            <div class="card-panel">
                <div class="tag-header">Configuración de Staff</div>
                <input type="text" id="st-nom" class="input-premium" placeholder="Nombre completo">
                <input type="number" id="st-pin" class="input-premium" placeholder="PIN (4 dígitos)">
                <input type="number" id="st-pag" class="input-premium" placeholder="Sueldo base por hora $">
                <button class="btn-premium gold-btn" onclick="window.addStaffMember()"><i class="fa-solid fa-user-plus"></i> DAR DE ALTA</button>
                <div id="lista-staff" style="margin-top:25px"></div>
            </div>

            <div class="card-panel">
                <div class="tag-header">Checklist Diario de Operación</div>
                <div style="display:flex; gap:15px; margin-bottom:20px">
                    <input type="text" id="task-name" class="input-premium" placeholder="Nueva tarea de limpieza..." style="margin:0">
                    <button class="btn-premium gold-btn" style="width:75px; padding:0" onclick="window.addNewTask()">+</button>
                </div>
                <div id="render-tasks"></div>
            </div>
        </div>
    </div>

    <nav id="command-bar">
        <div class="cmd-item" onclick="window.nav('finanzas')"><i class="fa-solid fa-vault"></i>Capital</div>
        <div class="cmd-item" onclick="window.nav('agenda')"><i class="fa-solid fa-calendar-day"></i>Agenda</div>
        <div class="cmd-item" onclick="window.nav('reloj')"><i class="fa-solid fa-clock"></i>Reloj</div>
        <div class="cmd-item" onclick="window.nav('bodega')"><i class="fa-solid fa-utensils"></i>Bodega</div>
        <div class="cmd-item" onclick="window.nav('admin')"><i class="fa-solid fa-user-shield"></i>Admin</div>
        <div class="cmd-item" onclick="location.reload()" style="color:var(--terracota); opacity:1"><i class="fa-solid fa-power-off"></i>Salir</div>
    </nav>

    <div id="os-modal" class="modal-os">
        <div class="modal-os-box" id="os-modal-content"></div>
    </div>

    <script type="module">
        import { db, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, orderBy, limit } from './firebase-config.js';

        // --- ESTADO MAESTRO ---
        let globalPin = "";
        let sessionUser = null;
        let activeCalDate = new Date();
        let activeCalDay = null;

        /**
         * SISTEMA DE COMUNICACIÓN UNIFICADO
         * @param {string} t Título de la notificación
         * @param {string} m Mensaje descriptivo
         * @param {boolean} e Determina si es un error (estética roja)
         */
        window.notifyOS = (t, m, e = false) => {
            const color = e ? 'var(--terracota)' : 'var(--dorado)';
            const icon = e ? 'fa-triangle-exclamation' : 'fa-circle-check';
            document.getElementById('os-modal-content').innerHTML = `
                <div style="margin-bottom:25px"><i class="fa-solid ${icon} fa-5x" style="color:${color}"></i></div>
                <h2 style="color:${color}; margin-bottom:15px; letter-spacing:3px; text-transform:uppercase">${t}</h2>
                <p style="opacity:0.8; margin-bottom:35px; line-height:1.7; font-size:1rem">${m}</p>
                <button class="btn-premium gold-btn" onclick="document.getElementById('os-modal').style.display='none'">CERRAR VENTANA</button>
            `;
            document.getElementById('os-modal').style.display = 'flex';
        };

        /**
         * ARQUITECTURA DE PINPAD RESPONSIVO
         */
        const renderNumpad = () => {
            const container = document.getElementById('numpad-logic');
            for(let i=1; i<=9; i++) {
                container.innerHTML += `<div class="key" onclick="window.inputKey(${i})">${i}</div>`;
            }
            container.innerHTML += `<div class="key" onclick="window.inputKey('DEL')" style="color:var(--terracota)"><i class="fa-solid fa-backspace"></i></div>`;
            container.innerHTML += `<div class="key" onclick="window.inputKey(0)">0</div>`;
            container.innerHTML += `<div class="key" onclick="location.reload()" style="color:var(--terracota)"><i class="fa-solid fa-power-off"></i></div>`;
        };

        window.inputKey = async (val) => {
            if(val === 'DEL') { globalPin = ""; updatePinDots(); return; }
            if(globalPin.length < 4) globalPin += val;
            updatePinDots();
            
            if(globalPin.length === 4) {
                try {
                    const q = query(collection(db, "usuarios"), where("pin", "==", globalPin));
                    const snap = await getDocs(q);
                    if(!snap.empty) {
                        sessionUser = { id: snap.docs[0].id, ...snap.docs[0].data() };
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('command-bar').style.display = 'grid';
                        initAppSequence();
                    } else {
                        globalPin = ""; updatePinDots();
                        window.notifyOS("ERROR DE ACCESO", "El código PIN ingresado no corresponde a ningún usuario activo.", true);
                    }
                } catch(err) {
                    window.notifyOS("ERROR DE RED", "No se pudo conectar con la base de datos de EscarolaOS.", true);
                }
            }
        };

        const updatePinDots = () => {
            const dots = document.querySelectorAll('.dot');
            dots.forEach((d, i) => d.classList.toggle('active', i < globalPin.length));
        };

        /**
         * SISTEMA DE NAVEGACIÓN Y PERMISOS
         */
        window.nav = (view) => {
            const socioViews = ['finanzas', 'admin'];
            if(socioViews.includes(view) && sessionUser.rol !== 'Socio') {
                window.notifyOS("ACCESO RESTRINGIDO", "Esta área está reservada exclusivamente para la gerencia (Socio).", true);
                return;
            }
            document.querySelectorAll('.main-viewport').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.cmd-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`view-${view}`).style.display = 'block';
            
            // Cargas específicas por módulo
            if(view === 'finanzas') loadFinanceData();
            if(view === 'agenda') renderCalendar();
            if(view === 'bodega') loadWarehouseData();
            if(view === 'admin') loadAdminData();
        };

        /**
         * MÓDULO: FINANZAS Y CAJA (RECONSTRUIDO)
         */
        window.saveFinance = async () => {
            const monto = parseFloat(document.getElementById('f-monto').value);
            const desc = document.getElementById('f-desc').value;
            if(!monto || !desc) return window.notifyOS("DATOS INCOMPLETOS", "Es obligatorio ingresar el concepto y el monto total.", true);

            await addDoc(collection(db, "finanzas"), {
                desc, monto,
                tipo: document.getElementById('f-tipo').value,
                canal: document.getElementById('f-canal').value,
                fecha: new Date().toISOString()
            });
            document.getElementById('f-monto').value = ""; document.getElementById('f-desc').value = "";
            loadFinanceData();
            window.notifyOS("REGISTRO EXITOSO", "El movimiento ha sido asentado en los libros contables.");
        };

        window.loadFinanceData = async () => {
            const snap = await getDocs(query(collection(db, "finanzas"), orderBy("fecha", "desc")));
            let ingresos = 0, gastos = 0;
            const container = document.getElementById('lista-finanzas');
            container.innerHTML = "";
            
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const isGasto = data.tipo === 'GASTO';
                if(isGasto) gastos += data.monto; else ingresos += data.monto;
                
                container.innerHTML += `
                    <div class="list-row">
                        <div><b>${data.desc}</b><br><small style="opacity:0.4">${data.canal}</small></div>
                        <div style="text-align:right">
                            <b class="${isGasto?'color-red':'color-gold'}" style="color:${isGasto?'var(--terracota)':'var(--dorado)'}">
                                ${isGasto?'-':'+'} $${data.monto.toFixed(2)}
                            </b>
                            <button onclick="window.secureDelete('finanzas','${docSnap.id}','loadFinanceData')" style="background:none; border:none; color:var(--terracota); margin-left:15px; cursor:pointer">×</button>
                        </div>
                    </div>`;
            });

            const neto = ingresos - gastos;
            document.getElementById('neto-val').innerText = `$${neto.toFixed(2)}`;
            document.getElementById('total-v').innerText = `$${ingresos.toFixed(0)}`;
            document.getElementById('total-g').innerText = `$${gastos.toFixed(0)}`;
            
            const totalFlujo = ingresos + gastos;
            if(totalFlujo > 0) {
                const util = ingresos > 0 ? ((neto / ingresos) * 100) : 0;
                document.getElementById('bar-v').style.width = (ingresos / totalFlujo * 100) + "%";
                document.getElementById('bar-g').style.width = (gastos / totalFlujo * 100) + "%";
                document.getElementById('perc-utilidad').innerText = `${util.toFixed(1)}% MARGEN DE UTILIDAD`;
                document.getElementById('label-status-fin').innerText = util > 25 ? "RENDIMIENTO ÓPTIMO" : "REVISIÓN DE COSTOS RECOMENDADA";
            }
        };

        /**
         * MÓDULO: AGENDA Y RESERVACIONES (ESTABLE)
         */
        window.navMonth = (dir) => { activeCalDate.setMonth(activeCalDate.getMonth() + dir); renderCalendar(); };

        window.renderCalendar = async () => {
            const grid = document.getElementById('cal-grid-render');
            grid.innerHTML = "";
            document.getElementById('cal-month-display').innerText = activeCalDate.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });

            const snap = await getDocs(collection(db, "agenda"));
            const registeredDates = snap.docs.map(d => d.data().fecha);

            const year = activeCalDate.getFullYear();
            const month = activeCalDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const hasEvent = registeredDates.includes(dateKey);
                const isSelected = activeCalDay === dateKey;
                grid.innerHTML += `<div class="cal-unit ${hasEvent?'marked':''} ${isSelected?'active':''}" onclick="window.selectDay('${dateKey}')">${i}</div>`;
            }
        };

        window.selectDay = (date) => {
            activeCalDay = date;
            document.getElementById('cal-selected-label').innerText = `DÍA SELECCIONADO: ${date}`;
            renderCalendar();
            loadDayEvents(date);
        };

        window.saveEvent = async () => {
            if(!activeCalDay) return window.notifyOS("SIN FECHA", "Debes seleccionar un día en el calendario.", true);
            const tit = document.getElementById('ev-tit').value;
            if(!tit) return;
            await addDoc(collection(db, "agenda"), { tit, hora: document.getElementById('ev-hor').value, fecha: activeCalDay });
            document.getElementById('ev-tit').value = "";
            renderCalendar(); loadDayEvents(activeCalDay);
        };

        window.loadDayEvents = async (fecha) => {
            const q = query(collection(db, "agenda"), where("fecha", "==", fecha));
            const snap = await getDocs(q);
            const list = document.getElementById('lista-agenda');
            list.innerHTML = "";
            snap.forEach(d => {
                list.innerHTML += `<div class="list-row"><span>${d.data().hora} - ${d.data().tit}</span> <button onclick="window.secureDelete('agenda','${d.id}','renderCalendar')">×</button></div>`;
            });
        };

        /**
         * MÓDULO: ALMACÉN Y RECETARIO (ROBUSTO)
         */
        window.saveInv = async () => {
            const item = document.getElementById('inv-nom').value;
            const qty = parseFloat(document.getElementById('inv-can').value);
            if(!item || isNaN(qty)) return;
            await addDoc(collection(db, "inventario"), { item, qty, fecha: new Date().toISOString() });
            document.getElementById('inv-nom').value = ""; document.getElementById('inv-can').value = "";
            loadWarehouseData();
        };

        window.saveRecipe = async () => {
            const nom = document.getElementById('rec-nom').value;
            if(!nom) return;
            await addDoc(collection(db, "recetas"), { nom, cost: document.getElementById('rec-cos').value, detail: document.getElementById('rec-det').value });
            document.getElementById('rec-nom').value = ""; document.getElementById('rec-cos').value = ""; document.getElementById('rec-det').value = "";
            loadWarehouseData();
        };

        window.loadWarehouseData = async () => {
            const invSnap = await getDocs(collection(db, "inventario"));
            const recSnap = await getDocs(collection(db, "recetas"));
            const iList = document.getElementById('lista-inventario');
            const rList = document.getElementById('lista-recetas');
            iList.innerHTML = ""; rList.innerHTML = "";

            invSnap.forEach(d => iList.innerHTML += `<div class="list-row"><span>${d.data().item}</span> <b>${d.data().qty} un. <button onclick="window.secureDelete('inventario','${d.id}','loadWarehouseData')">×</button></b></div>`);
            recSnap.forEach(d => rList.innerHTML += `<div class="list-row"><span>${d.data().nom}</span> <b>$${d.data().cost} <button onclick="window.secureDelete('recetas','${d.id}','loadWarehouseData')">×</button></b></div>`);
        };

        /**
         * MÓDULO: ADMINISTRACIÓN, NÓMINA Y STAFF
         */
        window.loadAdminData = async () => {
            loadPayrollCalculation();
            loadStaffManagement();
            loadOperationalChecklist();
        };

        window.loadPayrollCalculation = async () => {
            const users = await getDocs(collection(db, "usuarios"));
            const punches = await getDocs(collection(db, "asistencias"));
            const render = document.getElementById('render-nomina');
            render.innerHTML = "";

            users.forEach(uDoc => {
                const u = uDoc.data();
                const lastPayDate = u.ultimoPago ? new Date(u.ultimoPago) : new Date(0);
                const userPunches = punches.docs.map(p=>p.data()).filter(p => p.uid === uDoc.id && new Date(p.fecha) > lastPayDate).sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
                
                let totalHours = 0;
                for(let i=0; i<userPunches.length; i++){
                    if(userPunches[i].tipo==='ENTRADA' && userPunches[i+1]?.tipo==='SALIDA'){
                        totalHours += (new Date(userPunches[i+1].fecha) - new Date(userPunches[i].fecha)) / 3600000;
                        i++;
                    }
                }
                const amountToPay = totalHours * (u.sueldo || 0);
                render.innerHTML += `
                    <div class="list-row">
                        <div><b>${u.nombre}</b><br><small>${totalHours.toFixed(2)} horas trabajadas</small></div>
                        <div style="text-align:right">
                            <b style="display:block">$${amountToPay.toFixed(0)}</b>
                            <button class="gold-btn" style="padding:6px 12px; border-radius:10px; font-size:0.6rem; font-weight:900" onclick="window.executePayment('${uDoc.id}','${u.nombre}',${amountToPay})">LIQUIDAR</button>
                        </div>
                    </div>`;
            });
        };

        window.executePayment = async (uid, nom, total) => {
            if(total <= 0) return window.notifyOS("SIN SALDO", "Este colaborador no tiene horas acumuladas para liquidar.", true);
            if(!confirm(`¿Confirmas el pago de $${total} a ${nom}? Las horas volverán a cero.`)) return;
            
            await addDoc(collection(db, "finanzas"), { desc: `NÓMINA: ${nom}`, monto: total, tipo: 'GASTO', canal: 'CAJA', fecha: new Date().toISOString() });
            await updateDoc(doc(db, "usuarios", uid), { ultimoPago: new Date().toISOString() });
            window.notifyOS("PAGO REGISTRADO", `Se ha generado el egreso por $${total}. El contador de horas para ${nom} se ha reiniciado.`);
            loadAdminData();
        };

        window.addNewTask = async () => {
            const t = document.getElementById('task-name').value;
            if(!t) return;
            await addDoc(collection(db, "tareas"), { tarea: t, status: false });
            document.getElementById('task-name').value = "";
            loadOperationalChecklist();
        };

        window.loadOperationalChecklist = async () => {
            const snap = await getDocs(collection(db, "tareas"));
            const render = document.getElementById('render-tasks');
            render.innerHTML = "";
            snap.forEach(d => {
                render.innerHTML += `
                    <div class="list-row">
                        <input type="checkbox" style="width:22px; height:22px" ${d.data().status?'checked':''} onchange="window.toggleTaskStatus('${d.id}', this.checked)">
                        <span style="flex:1; margin-left:15px">${d.data().tarea}</span>
                        <button onclick="window.secureDelete('tareas','${d.id}','loadOperationalChecklist')" style="color:var(--terracota); background:none; border:none">×</button>
                    </div>`;
            });
        };

        window.toggleTaskStatus = async (id, s) => { await updateDoc(doc(db, "tareas", id), { status: s }); };

        window.addStaffMember = async () => {
            const n = document.getElementById('st-nom').value;
            const p = document.getElementById('st-pin').value;
            const s = parseFloat(document.getElementById('st-pag').value);
            if(!n || !p) return;
            await addDoc(collection(db, "usuarios"), { nombre: n, pin: p, sueldo: s, rol: 'Staff', ultimoPago: new Date().toISOString() });
            document.getElementById('st-nom').value = ""; document.getElementById('st-pin').value = "";
            loadStaffManagement();
        };

        window.loadStaffManagement = async () => {
            const snap = await getDocs(collection(db, "usuarios"));
            const list = document.getElementById('lista-staff');
            list.innerHTML = "";
            snap.forEach(d => list.innerHTML += `<div class="list-row">${d.data().nombre} (${d.data().rol}) <button onclick="window.secureDelete('usuarios','${d.id}','loadStaffManagement')">×</button></div>`);
        };

        /**
         * MÓDULO: CONTROL DE ASISTENCIA (RELOJ CHECADOR)
         */
        window.handlePunch = async (tipo) => {
            await addDoc(collection(db, "asistencias"), { uid: sessionUser.id, name: sessionUser.nombre, tipo, fecha: new Date().toISOString() });
            window.notifyOS("REGISTRO EXITOSO", `Se ha marcado tu ${tipo} el ${new Date().toLocaleTimeString()}.`);
            loadRecentPunches();
        };

        window.loadRecentPunches = async () => {
            const q = query(collection(db, "asistencias"), orderBy("fecha", "desc"), limit(6));
            const snap = await getDocs(q);
            const list = document.getElementById('lista-asistencias');
            list.innerHTML = "<h4 style='margin-bottom:20px; color:var(--dorado); letter-spacing:2px'>ÚLTIMOS MOVIMIENTOS</h4>";
            snap.forEach(d => list.innerHTML += `<div class="list-row"><span>${d.data().name}</span> <b style="color:var(--dorado)">${d.data().tipo}</b></div>`);
        };

        /**
         * UTILIDADES GLOBALES DE SISTEMA
         */
        window.secureDelete = async (col, id, callback) => {
            if(confirm("¿Estás seguro de eliminar permanentemente este registro del sistema? Esta acción no se puede deshacer.")) {
                await deleteDoc(doc(db, col, id));
                if(callback) window[callback]();
            }
        };

        const initAppSequence = () => {
            window.nav('reloj');
            loadFinanceData();
            loadRecentPunches();
            
            // RELOJ DE ALTA PRECISIÓN (REPARADO)
            setInterval(() => {
                const now = new Date();
                const clockElem = document.getElementById('live-time');
                const dateElem = document.getElementById('live-date');
                if(clockElem) clockElem.innerText = now.toLocaleTimeString('es-MX', { hour12: false });
                if(dateElem) dateElem.innerText = now.toLocaleDateString('es-MX', { weekday:'long', day:'numeric', month:'long' });
            }, 1000);
        };

        renderNumpad();
    </script>
</body>
</html>
